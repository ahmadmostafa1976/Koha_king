[% USE raw %]
[% USE Asset %]
[% USE AuthorisedValues %]
[% USE KohaDates %]
[% USE Koha %]
[% USE TablesSettings %]
[% USE JSON.Escape %]
[% PROCESS 'i18n.inc' %]
[% SET footerjs = 1 %]
[% USE To %]

[%- BLOCK area_name -%]
 [%- SWITCH area -%]
 [%- CASE 'CIRC' -%]<span>الإعارة</span>
 [%- CASE 'CAT'  -%]<span>الفهرس</span>
 [%- CASE 'PAT'  -%]<span>المستفيدين</span>
 [%- CASE 'ACQ'  -%]<span>التزويد</span>
 [%- CASE 'ACC'  -%]<span>الحسابات</span>
 [%- CASE 'SER'  -%]<span>الدوريات</span>
 [%- END -%]
[%- END -%]

[% INCLUDE 'doc-head-open.inc' %]

<title>[% FILTER collapse %]
 [% IF ( saved1 ) %]
 [% t("Saved reports") | html %] &rsaquo;
 [% ELSIF ( create ) %]
 [% t("Create from SQL") | html %] &rsaquo;
 [% ELSIF ( showsql ) %]
 [% t("SQL view") | html %] &rsaquo;
 [% t("Saved reports") | html %] &rsaquo;
 [% ELSIF ( execute ) %]
 [% tx("Report {reportname} ({id})", { reportname = name, id = id }) | html %] &rsaquo;
 [% t("Saved reports") | html %] &rsaquo;
 [% ELSIF ( editsql ) %]
 [% tx("Edit report {reportname} ({id})", { reportname = reportname, id = id }) | html %] &rsaquo;
 [% t("Saved reports") | html %] &rsaquo;
 [% END %]

 [% IF ( build1 ) %]
 [% t("Build a report, step 1 of 6: Choose a module") | html %] &rsaquo;
 [% ELSIF ( build2 ) %]
 [% t("Build a report, step 2 of 6: Pick a report type") | html %] &rsaquo;
 [% ELSIF ( build3 ) %]
 [% t("Build a report, step 3 of 6: Select columns for display") | html %] &rsaquo;
 [% ELSIF ( build4 ) %]
 [% t("Build a report, step 4 of 6: Select criteria to limit on") | html %] &rsaquo;
 [% ELSIF ( build5 ) %]
 [% t("Build a report, step 5 of 6: Pick which columns to total") | html %] &rsaquo;
 [% ELSIF ( build6 ) %]
 [% t("Build a report, step 6 of 6: Select how you want the report ordered") | html %] &rsaquo;
 [% END %]
 [% t("Guided reports wizard") | html %] &rsaquo;
 [% t("Reports") | html %] &rsaquo;
 [% t("Koha") | html %]
[% END %]</title>

[% INCLUDE 'doc-head-close.inc' %]
[% Asset.css("lib/codemirror/codemirror.min.css") | $raw %]
<style>
    .CodeMirror {
        resize:  vertical;
    }
    .cm-sqlParams {
        color: #11917B;
    }
    .cm-columnPlaceholder {
        color: #BF2D5D;
    }
    #mana_search_errortext {
        font-family: monospace; font-weight: bold;
    }
    .data-plain {
        display: none;
    }
    div.radio label {
        font-weight: bold;
        margin: 0;
    }
</style>
[% Asset.css("css/reports.css") | $raw %]
[% Asset.css("lib/d3c3/c3.min.css") | $raw %]
</head>

<body id="rep_guided_reports_start" class="rep">
[% WRAPPER 'header.inc' %]
 [% INCLUDE 'circ-search.inc' %]
[% END %]

[% WRAPPER 'sub-header.inc' %]
 [% WRAPPER breadcrumbs %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/reports/reports-home.pl">التقارير</a>
 [% END %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl">معالج التقارير الموجهة</a>
 [% END %]
 [% IF ( showsql || editsql || execute ) %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=list">تقارير محفوظة</a>
 [% END %]
 [% END %]
 [% IF ( saved1 ) %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 <span>تقارير محفوظة</span>
 [% END %]
 [% ELSIF ( create ) %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 <span>إنشاء من SQL</span>
 [% END %]
 [% ELSIF ( showsql ) %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 [% reportname | html %] ([% id | html %])
 [% END %]
 [% ELSIF ( editsql ) %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?id=[% id | uri %]&amp;op=show">[% reportname | html %] ([% id | html %])</a>
 [% END %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 <span>تحرير</span>
 [% END %]
 [% ELSIF ( execute ) %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?id=[% id | uri %]&amp;op=show">[% name | html %] ([% id | html %])</a>
 [% END %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 <span>تشغيل</span>
 [% END %]
 [% ELSIF ( build1 || build2 || build3 || build4 || build5 || build6 ) %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=add_form">إنشاء تقرير</a>
 [% END %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 [% IF ( build1 ) %]
 <span>الخطوة 1 من 6: اختر نظاماً فرعياً</span>
 [% ELSIF ( build2 ) %]
 <span>خطوة 2 من 6:إختر نوع التقرير</span>
 [% ELSIF ( build3 ) %]
 <span>الخطوة 3 من 6: اختر الأعمدة للعرض</span>
 [% ELSIF ( build4 ) %]
 <span>خطوة 4 من 6: إختر معيار للتحديد</span>
 [% ELSIF ( build5 ) %]
 <span>خطوة 5 من 6: إختر أيّ أعمدة للجمع</span>
 [% ELSIF ( build6 ) %]
 <span>خطوة 6 من 6: حدد الطريقة التي تريد ترتيب التقرير بها</span>
 [% END # /IF ( build1 ) %]
 [% END # /WRAPPER breadcrumb_item %]
 [% END # /IF ( saved1 ) %]
 [% END # /WRAPPER breadcrumbs %]
[% END # /WRAPPER 'sub-header.inc' %]

<div id="update_sql" class="modal" tabindex="-1" role="dialog" aria-labelledby="update_sql_label" aria-hidden="true">
 <div class="modal-dialog">
 <div class="modal-content">
 <div class="modal-header">
 <button type="button" class="closebtn" data-dismiss="modal" aria-hidden="true">×</button>
 <h3 id="update_sql_label">تحديث SQL</h3>
 </div>
 <div class="modal-body">
 <div id="loading"> <img src="[% interface | html %]/[% theme | html %]/img/spinner-small.gif" alt="" /> جاري التحميل </div>
 </div>
 <div class="modal-footer">
 <a href="#" class="btn btn-default" id="update_sql_button" role="button" data-toggle="modal">التحديث</a>
 <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">إغلاق</button>
 </div>
 </div> <!-- /.modal-content -->
 </div> <!-- /.modal-dialog -->
</div> <!-- #update_sql -->

<div class="main container-fluid">
 <div class="row">
 <div class="col-sm-10 col-sm-push-2">
 <main>
 [% INCLUDE 'messages.inc' %]

 [% INCLUDE "reports-toolbar.inc" %]

 [% IF ( start ) %]
 <h1>التقارير الموجهة</h1>
 <p>استخدم محرك التقارير الموجهة لعمل تقارير غير معيارية. هذه الميزة تهدف إلى تقديم بعض المواقع الوسيطة بين البناء في التقارير الجاهزة وكتابة تقارير  SQL مخصصة.</p>

 <h3>أنشئ و شغّل تقارير</h3>

 [% IF ( CAN_user_reports_create_reports ) %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=add_form" class="btn btn-primary"/>أنشئ جديد</a>
 [% END %]

 [% IF ( CAN_user_reports_execute_reports ) %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=list" class="btn btn-primary"/>استخدم المحفوظ</a>
 [% END %]

 [% IF ( CAN_user_reports_create_reports ) %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=add_form_sql" class="btn btn-primary"/>إنشاء تقرير من SQL</a>
 [% END %]

 <h3>قاموس التقارير</h3>
 <p>استخدم قاموس التقارير لتعريف معايير مخصصة للاستخدام في تقاريرك</p>
 <a href="/cgi-bin/koha/reports/dictionary.pl?op=list" class="btn btn-primary"/>عرض القاموس</a>
 [% END # /IF (start) %]

 [% IF report_converted %]
 <div class="dialog message">
 تم تحويل التقرير "[% report_converted | html %]". </div>
 [% END %]

 [% IF report_converted %]
 <div class="dialog message">
 تم تحويل التقرير "[% report_converted | html %]". </div>
 [% END %]

 [% IF ( saved1 ) %]
 <h1>تقارير محفوظة</h1>
 [% IF ( savedreports ) %]

 [% IF ( filters.date || filters.author || filters.keyword ) %]
 <p>منقح بواسطة: <span class="filter">
 [% IF ( filters.date ) %]
 <span class="filter_date"><strong>التاريخ:</strong> [% filters.date | html %]</span>
 [% END %]
 [% IF ( filters.author ) %]
 <span class="filter_author"><strong>المؤلف:</strong> [% filters.author | html %]</span>
 [% END %]
 [% IF ( filters.keyword ) %]
 <span class="filter_keyword"><strong>كلمة مفتاحية:</strong> [% filters.keyword | html %]</span>
 [% END %]
 <a class="clear_filter" href="/cgi-bin/koha/reports/guided_reports.pl?op=list&clear_filters=1"><i class="fa fa-times"></i> مسح</a>
 </span>
 </p>
 [% END %]

 [% WRAPPER tabs id= "tabs" %]
 [% WRAPPER tabs_nav %]
 [% WRAPPER tab_item tabname= "reports" bt_active= 1 %] <span>الكل</span> [% END %]
 [% FOREACH group IN groups_with_subgroups %]
 [% WRAPPER tab_item tabname= group.id %] <span>[% group.name | html %]</span> [% END %]
 [% END %]
 [% END # /WRAPPER tabs_nav %]

 [% WRAPPER tab_panels %]
 [% WRAPPER tab_panel tabname="reports" bt_active= 1 %]

 <div id="subgroup_filter_block">
 <label for="subgroup_filter">المجموعة الفرعية:</label>
 <select id="subgroup_filter">
 <option value="">الكل</option>
 </select>
 </div>

 [% IF (Koha.Preference('Mana') == 1) %]
 [% IF manamsg %]
 <div id="mana_search_message" class="dialog message">
 <p> [% manamsg | html %] </p>
 </div>
 [% END %]
 [% END %]

 <form action="/cgi-bin/koha/reports/guided_reports.pl" id="reports_form" method="post">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="op" value="cud-delete" />
 <table id="table_reports">
 <thead>
 <tr>
 <th class="NoSort">&nbsp;</th>
 <th>معرِّف</th>
 <th>اسم التقرير</th>
 <th>نوع</th>
 <th>مجموعة</th>
 <th>مجموعة فرعية</th>
 <th>ملاحظات</th>
 <th>مؤلف</th>
 <th>تاريخ الإنشاء</th>
 <th>آخر تحرير</th>
 <th>آخر تشغيل</th>
 <th class="report_public">عام</th>
 <th class="report_json_url">JSON URL</th>
 [% IF (usecache) %]
 <th>انتهاء الذاكرة المخبأة (ثوان)</th>
 [% ELSE %]
 <th class="NoVisible">انتهاء الذاكرة المخبأة (ثوان)</th>
 [% END %]
 <th>نتائج محفوظة</th>
 [% IF has_obsolete_reports %]
 <th>التحديث</th>
 [% ELSE %]
 <th class="NoVisible">التحديث</th>
 [% END %]
 <th class="NoSort noExport">الإجراءات</th>
 </tr>
 </thead>
 <tbody>
 [% FOREACH savedreport IN savedreports %]
 [% UNLESS ( loop.odd ) %]<tr class="odd">[% ELSE %]<tr>[% END %]
 <td class="report_checkbox">
 [% IF ( CAN_user_reports_delete_reports ) %] <!-- not break CSS -->
 <input type="checkbox" name="id" id="id_[% savedreport.id | html %]" value="[% savedreport.id | html %]" />
 [% END %]
 <input type="hidden" class="report_sql" value="[% savedreport.savedsql |html %]">
 </td>
 <td class="report_id">
 <label for="id_[% savedreport.id | html %]">[% savedreport.id | html %]</label>
 </td>
 <td class="report_name">
 [% IF ( savedreport.report_name ) %] [% savedreport.report_name | html %] [% ELSE %] [ بدون اسم ] [% END %] </td>
 <td class="report_type">
 [% savedreport.type | html %]
 </td>
 <td data-search="[% savedreport.report_group | html %]" class="report_group">
 [% savedreport.groupname | html %]
 </td>
 <td data-search="[% savedreport.report_subgroup | html %]">
 [% savedreport.subgroupname | html %]
 </td>
 <td class="report_notes">
 [% savedreport.notes | html %]
 </td>
 <td>
 [%- savedreport.borrowersurname | html -%][%- IF ( savedreport.borrowerfirstname ) -%], [%- savedreport.borrowerfirstname | html -%][%- END -%]
 ([% savedreport.borrowernumber | html %])
 </td>
 <td data-order="[% savedreport.date_created | html %]">
 [% savedreport.date_created | $KohaDates %]
 </td>
 <td data-order="[% savedreport.last_modified | html %]">
 [% savedreport.last_modified | $KohaDates  with_hours => 1 %]
 </td>
 <td data-order="[% savedreport.last_run | html %]">
 [% savedreport.last_run | $KohaDates  with_hours => 1 %]
 </td>
 <td class="report_public">
 [% IF (savedreport.public) %] نعم [% ELSE %] لا [% END %] </td>
 <td class="report_json_url">
 [% IF (savedreport.public) %]
 <a href="[% OPACBaseURL | url %]/cgi-bin/koha/svc/report?id=[% savedreport.id | uri %]">[% OPACBaseURL | html %]/cgi-bin/koha/svc/report?id=[% savedreport.id | html %]</a>
 [% ELSE %]
 <a href="/cgi-bin/koha/svc/report?id=[% savedreport.id | uri %]">[% Koha.Preference('staffClientBaseURL') | html %]/cgi-bin/koha/svc/report?id=[% savedreport.id | html %]</a>
 [% END %]
 </td>
 <td>
 [% savedreport.cache_expiry | html %]
 </td>
 <td>
 [% FOR result IN savedreport.results %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=retrieve_results&amp;id=[% result.id | uri %]">[% result.date_run | html %]</a>
 <br/>
 [% END %]
 </td>
 <td>
 [% IF savedreport.seems_obsolete %] يبدو أن هذا التقرير مهجور، فهو يستخدم حقل biblioitems.marcxml <a class="update_sql btn btn-default btn-xs" data-report_id="[% savedreport.id | html %]" href="/cgi-bin/koha/svc/convert_report?id=[% savedreport.id | uri %]" title="تحديث SQL"><i class="fa-solid fa-eye"></i> تحديث SQL</a>
 [% END %]
 </td>
 <td>
 <div class="btn-group dropup">
 [%# There should be no space between these two buttons, it would render badly %]
 <a class="btn btn-default btn-xs" role="button"
                                                                href="/cgi-bin/koha/reports/guided_reports.pl?id=[% savedreport.id | html %]&amp;op=run"><i
                                                                class="fa fa-play"></i> تشغيل</a><a
                                                                class="btn btn-default btn-xs dropdown-toggle" id="reportactions[% savedreport.id | html %]" role="button" data-toggle="dropdown"
                                                                href="#"><b class="caret"></b></a>
 <ul class="dropdown-menu pull-right" role="menu" aria-labelledby="reportactions[% savedreport.id | html %]">
 <li><a href="/cgi-bin/koha/reports/guided_reports.pl?id=[% savedreport.id | uri %]&amp;op=show"><i class="fa fa-search"></i> عرض</a></li>
 <li>
 <a href="/cgi-bin/koha/reports/guided_reports.pl?id=[% savedreport.id | uri %]&op=show" class="preview_sql" data-reportid="[% savedreport.id | html %]">
 <i class="fa-solid fa-eye"></i> معاينة SQL </a>
 </li>
 [% IF ( CAN_user_reports_create_reports ) %]
 <li><a href="/cgi-bin/koha/reports/guided_reports.pl?id=[% savedreport.id | uri %]&amp;op=edit_form"><i class="fa-solid fa-pencil" aria-hidden="true"></i> تحرير</a></li>
 <li><a href="/cgi-bin/koha/reports/guided_reports.pl?op=duplicate&id=[% savedreport.id | uri %]" title="نسخ هذا التقرير المحفوظ"><i class="fa fa-copy"></i> نسخ</a></li>
 [% END %]
 [% IF (Koha.Preference('Mana') == 1) %]
 <li><a class="ShareButton" data-toggle="modal" href="#mana_share_report" title="مشاركة تقريرك مع قاعدة معرفة مانا"><i class="fa fa-share-alt"></i> مشاركة</a></li>
 [% END %]
 <li><a href="/cgi-bin/koha/tools/scheduler.pl?id=[% savedreport.id | uri %]"><i class="fa-solid fa-clock"></i> الجداول</a></li>
 [% IF ( CAN_user_reports_delete_reports ) %]
 <li>
 <form method="post" action="/cgi-bin/koha/reports/guided_reports.pl">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="op" value="cud-delete" />
 <input type="hidden" name="id" value="[% savedreport.id | html %]" />
 </form>
 <a class="delete" href="#" title="حذف هذه التقارير المحفوظة"><i class="fa fa-trash-can"></i> حذف</a>
 </li>
 [% END %]
 </ul>
 </div>
 <input type="hidden" id="previewSql[% savedreport.id | html %]" value="[% savedreport.savedsql | html %]" data-title="[% savedreport.report_name | html %]" />
 </td>
 </tr>
 [% END %]
 </tbody>
 </table>

 [% IF ( CAN_user_reports_delete_reports ) %]
 <fieldset class="action">
 <input class="btn btn-primary" type="submit" value="حذف المحدد" />
 </fieldset>
 [% END %]
 </form>
 [% END # /tab_panel# %]
 [% END # /WRAPPER tab_panels %]
 [% END # /WRAPPER tabs %]




 [% ELSE # IF ( savedreports ) %]
 <div class="dialog message">
 [% IF (filter_set || filters.date || filters.author || filters.keyword) %]
 <h4>لا توجد تقارير محفوظة تطابق معاييرك. </h4>
 [% IF ( CAN_user_reports_create_reports ) %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=add_form" class="new btn btn-default"><i class="fa fa-plus"></i> تقرير موجه جديد</a>

 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=add_form_sql" class="new btn btn-default"><i class="fa fa-plus"></i> قاعدة بينات جديدة</a>

 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=list&filter_set=1&filter_keywork=" class="deny btn btn-default"><i class="fa fa-fw fa-times"></i> إلغاء المنقح</a>
 [% END %]
 [% ELSE %]
 <h4>ليس هناك تقارير محفوظة. </h4>
 [% IF ( CAN_user_reports_create_reports ) %]
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=add_form">إنشاء تقرير جديد؟</a>
 [% END %]
 [% END # IF (filter_set || filters.date || filters.author || filters.keyword) %]
 </div> <!-- /.dialog.message -->
 [% END # /IF ( savedreports ) %]
 [% END # /IF ( saved1 ) %]

 [% INCLUDE 'mana/mana-share-report.inc' %]

 [% IF ( build1 ) %]
 [% IF ( cache_error) %]
 <div class="dialog alert">
 <strong> يرجى اختيار cache_expiry أقل من 30 يوما </strong>
 </div>
 [% END %]

 <h1>إنشاء تقرير</h1>
 <form method="post" action="/cgi-bin/koha/reports/guided_reports.pl">
 [% INCLUDE 'csrf-token.inc' %]
 <fieldset class="rows">
 <legend>خطوة 1 من 6:قم باختيار نظام فرعي للتقرير عليه,[% IF (usecache) %]ضبط صلاحية التخبأة, [% END %] واختر عرض التقرير </legend>
 <ol>
 <li>
 <label for="area">اختر: </label>
 <select name="area" id="area">
 [%- FOREACH area IN areas -%]
 <option value="[% area | html %]">[%- PROCESS area_name area=area -%]</option>
 [%- END -%]
 </select>
 </li>
 [% IF (public) %]
 <li>
 <label for="public">التقرير عام:</label>
 <select id="public" name="public">
 <option value="0">لا (افتراضي)</option>
 <option value="1" selected="selected">نعم</option>
 </select>
 </li>
 [% ELSE %]
 <li>
 <label for="public">التقرير عام:</label>
 <select id="public" name="public">
 <option value="0" selected="selected">لا (افتراضي)</option>
 <option value="1">نعم</option>
 </select>
 </li>
 [% END %]

 [% IF (usecache) %]
 <li>
 <label for="cache_expiry">انتهاء التخبأة:</label>
 <input type="text" id="cache_expiry" name="cache_expiry" value="[% cache_expiry | html %]"></input>
 <select id="cache_expiry_units" name="cache_expiry_units">
 <option value="seconds">ثوانٍ (الافتراضي)</option>
 <option value="minutes">دقائق</option>
 <option value="hours">ساعات</option>
 <option value="days">أيام</option>
 </select>
 </li>
 [% END %]
 </ol>
 </fieldset> <!-- /.rows -->
 <fieldset class="action">
 <input type="hidden" name="op" value="cud-report" />
 <button type="submit" class="btn btn-primary" />التالى&gt;&gt;</button>
 </fieldset>
 </form>
 [% END # /build1 %]

 [% IF ( build2 ) %]
 <h1>إنشاء تقرير</h1>
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="post">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="area" value="[% area | html %]" />
 <input type="hidden" name="public" value="[% public | html %]" />
 <input type="hidden" name="cache_expiry" value="[% cache_expiry | html %]" />
 <fieldset class="rows">
 <legend>خطوة 2 من 6:إختر نوع التقرير</legend>
 <ol>
 <li>
 <label for="types">اختر: </label>
 <select id="types" name="types">
 <option value="1">مجدول</option>
 <option value="2" disabled="disabled">ملخص</option>
 <option value="3" disabled="disabled">مصفوفة</option>
 </select>
 </li>
 </ol>
 </fieldset>

 <fieldset class="action">
 <input type="hidden" name="op" value="cud-choose_type" />
 <button type="submit" class="btn btn-default goback" name="back">&lt;&lt; Back</button>
 <button type="submit" class="btn btn-primary" />التالى&gt;&gt;</button>
 </fieldset>
 </form>
 [% END # /IF (build2 ) %]

 [% IF ( build3 ) %]
 <h1>إنشاء تقرير</h1>
 <h3>الخطوة 3 من 6: اختر الأعمدة للعرض</h3>
 <p>ملاحظة: كن حذراً في التحديد عند تحديدك للأعمدة. إذا كان اختيارك واسع أكثر من اللازم، يمكن أن يؤدي إلى تقرير كبير جداً، الذي بدوره لن يكتمل، أو سيبطئ نظامك.</p>

 <form id="column_submit" action="/cgi-bin/koha/reports/guided_reports.pl" method="post">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="area" value="[% area | html %]" />
 <input type="hidden" name="type" value="[% type | html %]" />
 <input type="hidden" name="public" value="[% public | html %]" />
 <input type="hidden" name="cache_expiry" value="[% cache_expiry | html %]" />
 <fieldset>
 <div class="row">
 <div class="col-sm-6">
 <div style="float: left;">
 <select id="availableColumns" name="oldcolumns2" multiple="multiple" size="25" style="min-width: 200px;height:300px;">
 [% FOREACH column IN columns %]
 [% IF ( column.table ) %]
 [% IF ( loop.first ) %]
 [% ELSE %]
 </optgroup>
 [% END %]
 <optgroup label="[% column.table | html %]">
 [% ELSE %]
 <option value="[% column.name | html %]">
 [% IF ( column.description ) %]
 [% column.description | html %] &nbsp; / &nbsp; [% column.name | html %]
 [% ELSE %]
 [% column.name | html %]
 [% END %]
 </option>
 [% END %]
 [% END %]
 </optgroup>
 </select>
 </div>
 <div style="width: 6.3em; float: right; margin-top: 100px">
 <input class="button" id="addColumn" name="Add" style="width:6em;" type="button" value="إضافة" /><br />
 <input class="button" id="delColumn" name="delete" style="width: 6em; margin: 1em 0;" type="button" value="<<حذف" />
 </div>
 </div> <!-- /.col-sm-6 -->

 <div class="col-sm-6">
 <select id="selectedColumns" name="columns" multiple="multiple" size="25" style="width:200px; height:300px;">
 </select>
 </div>
 </div> <!-- /.row -->
 </fieldset>
 <fieldset class="action">
 <input type="hidden" name="op" value="cud-choose_columns" />
 <button type="submit" class="btn btn-default goback" name="back">&lt;&lt; Back</button>
 <button type="submit" class="btn btn-primary" />التالى&gt;&gt;</button>
 </fieldset>
 </form> <!-- /#column_submit -->
 [% END # /IF ( build3 ) %]

 [% IF ( build4 ) %]
 <h1>إنشاء تقرير</h1>
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="post" >
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="area" value="[% area | html %]" />
 <input type="hidden" name="type" value="[% type | html %]" />
 <input type="hidden" name="column" value="[% column | html %]" />
 <input type="hidden" name="public" value="[% public | html %]" />
 <input type="hidden" name="cache_expiry" value="[% cache_expiry | html %]" />
 <fieldset>
 <legend>خطوة 4 من 6: إختر معيار للتحديد</legend>
 <table>
 [% FOREACH criteri IN criteria %]
 <tr>
 <td>
 <input type="checkbox" name="criteria_column" id="[% criteri.name | html %]" value="[% criteri.name | html %]" />
 <label for="[% criteri.name | html %]">[% criteri.description | html %] </label>
 </td>
 [% IF ( criteri.date ) %]
 <td>
 <input type="text" size="10" id="[% criteri.name | html %]_value" name="[% criteri.name | html %]_value" value="" class="flatpickr" />
 <span class="hint">[% INCLUDE 'date-format.inc' %]</span>
 </td>
 </tr>
 [% ELSE %]
 [% IF ( criteri.textrange ) %]
 <td>
 من <input type="text" size="10" id="[% criteri.from | html %]_value" name="[% criteri.from | html %]_value" value="" /> إلى <input type="text" size="10" id="[% criteri.to | html %]_value" name="[% criteri.to | html %]_value" value="" />
 </td>
 </tr>
 [% ELSE %]
 [% IF ( criteri.daterange ) %]
 <td>
 من <input type="text" size="10" id="from_[% criteri.name.remove('\.') | html %]_value" name="from_[% criteri.name | html %]_value" value="" data-date_to="to_[% criteri.name.remove('\.') | html %]_value" class="flatpickr" />
 إلى <input type="text" size="10" id="to_[% criteri.name.remove('\.') | html %]_value" name="to_[% criteri.name | html %]_value" value="" class="flatpickr" />
 <span class="hint">[% INCLUDE 'date-format.inc' %]</span>
 </td>
 </tr>
 [% ELSE %]
 <td>
 <select name="[% criteri.name | html %]_value">
 [% FOREACH value IN criteri.values %]
 <option value="[% value.availablevalues | html %]">
 [% IF ( value.default ) %] الافتراضي [% ELSE %] [% value.display_value | html %] [% END %] </option>
 [% END %]
 </select>
 </td>
 </tr>
 [% END %]
 [% END %]
 [% END %]
 [% END %]
 </table>
 </fieldset>

 [% IF ( definitions ) %]
 <fieldset>
 <legend>تعريفات القاموس</legend>
 <table>
 [% FOREACH definition IN definitions %]
 <tr>
 <td>
 <input type="checkbox" name="definition" value="[% definition.id | html %]" />
 [% definition.name | html %]
 </td>
 </tr>
 [% END %]
 </table>
 </fieldset>
 [% END %]

 <fieldset class="action">
 <input type="hidden" name="op" value="cud-choose_criteria" />
 <button type="submit" class="btn btn-default goback" name="back">&lt;&lt; Back</button>
 <button type="submit" class="btn btn-primary" />التالى&gt;&gt;</button>
 </fieldset>
 </form>
 [% END # /IF ( build4 ) %]

 [% IF ( build5 ) %]
 <h1>إنشاء تقرير</h1>
 <h3>خطوة 5 من 6: إختر أيّ أعمدة للجمع</h3>
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="post">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="area" value="[% area | html %]" />
 <input type="hidden" name="type" value="[% type | html %]" />
 <input type="hidden" name="column" value="[% column | html %]" />
 <input type="hidden" name="definition" value="[% definition | html %]" />
 <input type="hidden" name="criteria" value="[% criteriastring | html %]" />
 <input type="hidden" name="public" value="[% public | html %]" />
 <input type="hidden" name="cache_expiry" value="[% cache_expiry | html %]" />
 <fieldset>
 <table>
 [% FOREACH total_b IN total_by %]
 <tr>
 <td>
 <input type="checkbox" name="total_by" id="[% total_b.name | html %]" value="[% total_b.name | html %]" />
 <label for="[% total_b.name | html %]">[% total_b.name | html %]</label>
 </td>
 <td>
 <select name="[% total_b.name | html %]_tvalue">
 [% FOREACH selec IN total_b.select %]
 <option value="[% selec.value | html %]">[% selec.value | html %]</option>
 [% END %]
 </select>
 </td>
 </tr>
 [% END %]
 </table>
 </fieldset>

 <fieldset class="action"><input type="hidden" name="op" value="cud-choose_operations" />
 <button type="submit" class="btn btn-default goback" name="back">&lt;&lt; Back</button>
 <button type="submit" class="btn btn-primary" />التالى&gt;&gt;</button>
 </fieldset>
 </form>
 [% END # /IF ( build5 ) %]

 [% IF ( build6 ) %]
 <h1>إنشاء تقرير</h1>
 <h3>خطوة 6 من 6: اختر الطريقة التي تريد التقرير بها</h3>
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="post">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="area" value="[% area | html %]" />
 <input type="hidden" name="type" value="[% type | html %]" />
 <input type="hidden" name="column" value="[% column | html %]" />
 <input type="hidden" name="criteria" value="[% criteriastring | html %]" />
 <input type="hidden" name="definition" value="[% definition | html %]" />
 <input type="hidden" name="totals" value="[% totals | html %]" />
 <input type="hidden" name="public" value="[% public | html %]" />
 <input type="hidden" name="cache_expiry" value="[% cache_expiry | html %]" />
 <fieldset>
 <table>
 [% FOREACH order_b IN order_by %]
 <tr>
 <td>
 <input type="checkbox" id="[% order_b.name | html %]" name="order_by" value="[% order_b.name | html %]" />
 <label for="[% order_b.name | html %]">[% order_b.name | html %]</label>
 </td>
 <td>
 <select name="[% order_b.name | html %]_ovalue">
 [% FOREACH selec IN order_b.select %]
 <option value="[% selec.value | html %]">[% selec.value | html %]</option>
 [% END %]
 </select>
 </td>
 </tr>
 [% END %]
 </table>
 </fieldset>
 <fieldset class="action">
 <input type="hidden" name="op" value="cud-build_report" />
 <input class="btn btn-primary" name="submit" type="submit" value="إنتهى" />
 </fieldset>
 </form>
 [% END #/ IF ( build6 ) %]

 [% IF ( showreport ) %]
 <h1>تأكيد التقرير المخصص</h1>
 <p>سيتم توليد التقرير الخاص بك ببيان SQL التالي.</p>
 <p>
 [% sql | html %]
 </p>

 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="post">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="sql" value="[% sql | html %]" />
 <input type="hidden" name="type" value="[% type | html %]" />
 <input type="hidden" name="public" value="[% public | html %]" />
 <input type="hidden" name="cache_expiry" value="[% cache_expiry | html %]" />
 <p>ستحتاج الى حفظ التقرير قبل أن تتمكن من تنفيذه</p>
 <fieldset class="action"><input type="hidden" name="op" value="cud-save" />
 <input class="btn btn-primary" name="submit" type="submit" value="التالى" />
 </fieldset>
 </form>
 [% END #/ IF ( showreport ) %]

 [% IF ( save ) %]
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="post" id="sql_report_form">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="sql" value="[% sql | html %]" />
 <input type="hidden" name="type" value="[% type | html %]" />
 <input type="hidden" name="area" value="[% area | html %]" />
 <input type="hidden" name="public" value="[% public | html %]" />
 <input type="hidden" name="cache_expiry" value="[% cache_expiry | html %]" />
 <fieldset class="rows">
 <legend><h1>حفظ تقريرك المخصص</h1></legend>
 <ol>
 <li>
 <label for="reportname" class="required">اسم التقرير: </label>
 <input type="text" id="reportname" name="reportname" class="required" required="required" />
 <span class="required">مطلوب</span>
 </li>
 [% PROCESS group_and_subgroup_selection %]
 <li>
 <label for="notes">ملاحظات:</label>
 <textarea name="notes" id="notes"></textarea>
 </li>
 </ol>
 </fieldset>
 <fieldset class="action"><input type="hidden" name="op" value="cud-save" />
 <input class="btn btn-primary" name="submit" type="submit" value="حفظ التقرير" />
 </fieldset>
 </form>
 [% END # /IF( save ) %]

 [% IF ( warn_authval_problem ) %]
 <div class="dialog alert">
 <h3>تم العثور على أخطاء أثناء معالجة الضوابط للتقرير:[% name | html %]</h3>
 [% FOREACH problematic_authval IN problematic_authvals %]
 <p>
 <strong>[% problematic_authval.name | html %]:</strong> فئة قيمة الاستناد (<strong>[% problematic_authval.authval | html %]</strong>) الذي حددته غير موجود. </p>
 [% END %]
 <!-- Save Anyway Form -->
 <form method="post" action='/cgi-bin/koha/reports/guided_reports.pl'>
 <!--Every parameter the user issued is provided as a hidden field for recovery-->
 [% INCLUDE 'csrf-token.inc' %]
 <input type='hidden' name='id' value='[% id | html %]' />
 <input type='hidden' name='sql' value='[% sql | html %]' />
 <input type='hidden' name='reportname' value='[% reportname | html %]' />
 <input type='hidden' name='group' value='[% group | html %]' />
 <input type='hidden' name='subgroup' value='[% subgroup | html %]' />
 <input type='hidden' name='notes' value='[% notes | html %]' />
 <input type='hidden' name='cache_expiry' value='[% cache_expiry | html %]' />
 <input type='hidden' name='cache_expiry_units' value='[% cache_expiry_units | html %]' />
 <input type='hidden' name='public' value='[% public | html %]' />
 [% IF ( op == 'update') %]
 <input type='hidden' name='op' value='cud-update' />
 <button type="submit" name="save_anyway" value="Save anyway" class="approve"><i class="fa fa-fw fa-check"></i> الحفظ على أي حال</button>
 [% ELSIF ( op == 'save') %]
 <input type='hidden' name='area' value='[% area | html %]' />
 <input type='hidden' name='op' value='cud-save' />
 <button type="submit" name="save_anyway" value="Save anyway" class="approve"><i class="fa fa-fw fa-check"></i> الحفظ على أي حال</button>
 [% END %]
 </form>
 <!-- Go back to editing -->
 <a href="/cgi-bin/koha/reports/guided_reports.pl" class="btn btn-default new goback"><i class="fa-fw fa-solid fa-pencil" aria-hidden="true"></i> تحرير SQL</a>
 </div>
 [% END # /IF ( warn_authval_problem )%]

 [% IF ( enter_params ) %]
 [% IF ( auth_val_error ) %]
 <div class="dialog alert">
 <h3>تم العثور على أخطاء أثناء معالجة الضوابط للتقرير:[% name | html %]</h3>
 [% FOREACH auth_val_error IN auth_val_errors %]
 <p>
 <strong>[% auth_val_error.entry | html %]:</strong> فئة قيمة الاستناد (<strong>[% auth_val_error.auth_val | html %]</strong>) الذي حددته غير موجود. </p>
 [% END %]
 </div>
 <fieldset class="action">
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=edit_formid=[% id | uri %]" class="btn btn-primary">تحرير SQL</a>
 </fieldset>
 [% ELSE #  IF ( auth_val_error ) %]
 <form method="get" action='/cgi-bin/koha/reports/guided_reports.pl' id='report_param_form'>
 <input type='hidden' name='id' value="[% id | html %]" />
 <h1>إدخال المعاملات للتقرير[% name | html %]:</h1>
 [% IF ( notes ) %]
 <p>[% notes | html %]</p>
 [% END %]
 <fieldset class="rows">
 <ol>
 [% FOREACH sql_param IN sql_params %]
 <input name="param_name" value="[% sql_param.name | html %]" type="hidden" />
 [% IF sql_param.input == 'date' %]
 <li>
 <label for="date_[% sql_param_entry | html %][% loop.count | html %]">[% sql_param.entry | html %]:</label> <input id="date_[% sql_param_entry | html %][% loop.count | html %]" type="text" value="" size="10" name="sql_params" class="flatpickr" />
 </li>
 [% ELSIF ( sql_param.input == 'text' ) %]
 <li>
 <label for="sql_params[% loop.count | html %]">[% sql_param.entry | html %]: </label>
 <input id="sql_params[% loop.count | html %]" type="text" name="sql_params" />
 </li>
 [% ELSIF ( sql_param.input == 'textarea' ) %]
 <li>
 <label for="sql_params[% loop.count | html %]">[% sql_param.entry | html %]: </label>
 <textarea id="sql_params[% loop.count | html %]" name="sql_params" rows="5"></textarea>
 </li>
 [% ELSE %]
 <li>
 <label for="sql_params_[% sql_param.labelid | html %]">[% sql_param.entry | html %]:</label>
 [% IF (sql_param.select_multiple) %]
 <select name="[%- sql_param.input.name | html -%]" tabindex="1"  id="[%- sql_param.input.id | html -%]" multiple>
 <option value="null" hidden></option>
 [% ELSE %]
 <select name="[%- sql_param.input.name | html -%]" tabindex="1"  id="[%- sql_param.input.id | html -%]">
 [% END %]
 [% IF (sql_param.include_all) %]
 <option value="%">الكل</option>
 [% END %]
 [% FOREACH value IN sql_param.input.values %]
 <option value="[%- value | html -%]">[%- sql_param.input.labels.$value | html -%]</option>
 [% END %]
 </select>
 </li>
 [% END # /IF sql_param.input == 'date' %]
 [% END # /FOREACH sql_param %]
 </ol>
 </fieldset> <!-- /.rows -->
 <fieldset class="action">
 <input type="hidden" name="op" value="run" />
 <button type="submit" class="btn btn-primary">تشغيل التقرير</button>
 </fieldset>
 </form>
 [% END # / IF ( auth_val_error ) %]
 [% END # /IF ( enter_params ) %]

 [% IF processed_notice %]
 [% processed_notice | $raw %]
 [% ELSIF ( execute ) %]
 <h1>[% name | html %] <span class="report_heading_id"><span class="report_label">معرّف التقرير:</span> <span class="report_number">[% id | html %]</span></span></h1>
 <div class="page-section">
 [% IF ( notes ) %]
 <p><span class="label">ملاحظات:</span> [% notes | html %]</p>
 [% END %]
 [% IF ( unlimited_total ) %]
 <p>
 <span class="label">إجمالي عدد النتائج:</span>
 [% unlimited_total | html %] [% IF unlimited_total >= limit %] ([% results.size | html %] معروض) [% END %] </p>
 [% END %]

 <div id="sql_output" style="display:none;">
 <span class="label">تقرير SQL:</span>
 <textarea id="sql" readonly="readonly">[% sql | html %]</textarea>
 </div>

 <div>
 <a href="#" id="toggle_chart_settings_hid" class="toggle_chart_settings" style="display:none"><i class="fa-solid fa-eye-slash"></i> إخفاء الرسم البياني</a>
 <a href="#" id="toggle_chart_settings_vis" class="toggle_chart_settings" style="display:none"><i class="fa-solid fa-eye"></i> عرض الرسم البياني</a>
 </div>
 <div id="chart" class="clearfix"></div>

 [% IF ( execute ) %]
 [% UNLESS ( errors ) %]
 <form method="post" enctype="multipart/form-data" action="/cgi-bin/koha/tools/batch_record_modification.pl" id="batch_record_modification" target="_blank">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="recordtype" value="biblio" />
 <input type="hidden" name="op" value="cud-list" />
 [% # Preserve the whitespace of the following textarea in order to format the values correctly %]
 <textarea style="display:none" name="recordnumber_list" id="recordnumber_list">
 [%- recordnumbers = PROCESS batch_list results=results batch_type='biblionumber' | trim | html %][% IF recordnumbers %][% SET batch_biblionumbers = 1 %][% recordnumbers | html %][% END -%]
 </textarea>
 </form>

 <form method="POST" action="/cgi-bin/koha/tools/batch_delete_records.pl" id="batch_record_deletion" target="_blank">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="recordtype" value="biblio" />
 <input type="hidden" name="op" value="cud-list" />
 [% # Preserve the whitespace of the following textarea in order to format the values correctly %]
 <textarea style="display:none" name="recordnumber_list" id="recordnumber_list">
 [%- recordnumbers = PROCESS batch_list results=results batch_type='biblionumber' | trim | html %][% IF recordnumbers %][% SET batch_biblionumbers = 1 %][% recordnumbers | html %][% END -%]
 </textarea>
 </form>

 <form method="POST" action="/cgi-bin/koha/tools/batchMod.pl" id="batch_item_modification" target="_blank">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="op" value="cud-show" />
 [% FOREACH result IN results %]
 [% FOREACH cells IN result.cells %]
 [% place = loop.index %]
 [% NEXT UNLESS cells.cell.match('^(\d+)$') %]
 [% IF header_row.$place.cell == 'itemnumber' || header_types.item(header_row.$place.cell) == 'itemnumber'  %]
 [% SET batch_itemnumbers = 1 %]
 [% SET header_row.$place.has_itemnumbers = 1 %]
 <input type="hidden" name="[% header_row.$place.cell | html %]" value="[% cells.cell | html %]" />
 [% END %]
 [% END %]
 [% END %]
 </form>

 <form method="POST" action="/cgi-bin/koha/tools/batchMod.pl" id="batch_item_deletion" target="_blank">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="op" value="cud-show" />
 <input type="hidden" name="del" value="1" />
 [% FOREACH result IN results %]
 [% FOREACH cells IN result.cells %]
 [% place = loop.index %]
 [% NEXT UNLESS cells.cell.match('^(\d+)$') %]
 [% IF header_row.$place.cell == 'itemnumber' || header_types.item(header_row.$place.cell) == 'itemnumber'  %]
 [% SET batch_itemnumbers = 1 %]
 [% SET header_row.$place.has_itemnumbers = 1 %]
 <input type="hidden" name="[% header_row.$place.cell | html %]" value="[% cells.cell | html %]" />
 [% END %]
 [% END %]
 [% END %]
 </form>

 <form method="get" action="/cgi-bin/koha/virtualshelves/addbybiblionumber.pl" id="batch_add_to_list" target="_blank">
 [% FOREACH result IN results %]
 [% FOREACH cells IN result.cells %]
 [% place = loop.index %]
 [% NEXT UNLESS cells.cell.match('^(\d+)$') %]
 [% IF header_row.$place.cell == 'biblionumber' || header_types.item(header_row.$place.cell) == 'biblionumber' %]
 [% SET batch_biblionumbers = 1 %]
 [% SET header_row.$place.has_biblionumbers = 1 %]
 <input type="hidden" class="bib_to_list" name="biblionumber" value="[% cells.cell | html %]" />
 [% END %]
 [% END %]
 [% END %]
 </form>

 <form method="get" action="/cgi-bin/koha/tools/modborrowers.pl" id="batch_patron_modification" target="_blank">
 <input type="hidden" name="op" value="show" />
 [% # Preserve the whitespace of the following textarea in order to format the values correctly %]
 [%- cardnumbers = PROCESS batch_list results=results batch_type='cardnumber' | trim | html %]
 [% IF cardnumbers %]
 [% SET batch_cardnumbers = cardnumbers.length %]
 [% FOR b IN cardnumbers.split("\n") %]
 <input type="hidden" name="cardnumber" value="[% b | uri %]" />
 [% END -%]
 [% END %]

 </form>

 <form action="/cgi-bin/koha/patroncards/edit-batch.pl" id="patron_card_creator" method="post" target="_blank">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="op" value="cud-add" />
 <input type="hidden" name="batch_id" value="0" />
 [% # Preserve the whitespace of the following textarea in order to format the values correctly %]
 <textarea style="display:none;" name="bor_num_list" id="bor_num_list">
 [%- borrowernumbers = PROCESS batch_list results=results batch_type='borrowernumber' | trim | html %][% IF borrowernumbers %][% SET batch_borrowernumbers = 1 %][% borrowernumbers | html %][% END -%]
 </textarea>
 </form>

 [% BLOCK batch_list %]
 [%- FOREACH result IN results %]
 [%- FOREACH cells IN result.cells %]
 [%- place = loop.index %]
 [%- IF header_row.$place.cell == batch_type || header_types.item(header_row.$place.cell) == batch_type %]
[%# We must not add whitespace to the cardnumbers %][% cells.cell | html %]
 [%- END %]
 [%- END %]
 [%- END -%]
 [% END %]

 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="get" id="limitselect">
 <input type="hidden" name="op" value="run"/>
 <input type="hidden" name="id" value="[% id | html %]"/>
 [% FOREACH p IN sql_params %]
 <input type="hidden" name="sql_params" value="[% p | html %]"/>
 [% END %]
 [% FOREACH n IN param_names %]
 <input type="hidden" name="param_name" value="[% n | html %]"/>
 [% END %]
 <input type="hidden" name="limit" id="limit" value="20" />
 </form> <!-- /#limitselect -->

 [% IF ( batch_biblionumbers || batch_itemnumbers || batch_cardnumbers || batch_borrowernumbers ) || ( unlimited_total > 10 && limit <= 1000 ) %]
 <div id="toolbar" class="btn-toolbar">
 [% IF ( batch_biblionumbers || batch_itemnumbers || batch_cardnumbers || batch_borrowernumbers ) %]
 <div class="btn-group">
 <button class="btn btn-default btn-sm dropdown-toggle" type="button" id="batch_mod_menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
 عمليات بالدفعة مع [% IF unlimited_total >= limit %][% results.size | html %][% ELSE %][% unlimited_total | html %][% END %] تسجيلة مرئية <span class="caret"></span>
 </button>
 <ul class="dropdown-menu" aria-labelledby="batch_mod_menu">
 [% FOREACH header_ro IN header_row %]
 [% IF header_ro.cell == 'cardnumber' || header_types.item( header_ro.cell ) == 'cardnumber' || header_ro.cell == 'borrowernumber' || header_types.item( header_ro.cell ) == 'borrowernumber' %]
 [% IF header_ro.cell == 'cardnumber' || header_types.item( header_ro.cell ) == 'cardnumber' %]
 [% SET show_cardnumber_ops = 1 %]
 [% END %]
 [% IF header_ro.cell == 'borrowernumber' || header_types.item( header_ro.cell ) == 'borrowernumber' %]
 [% SET show_borrowernumber_ops = 1 %]
 [% END %]
 [% END %]
 [% END %]
 [% IF show_cardnumber_ops || show_borrowernumber_ops %]
 <li class="dropdown-header">تسجيلات المستفيد</li>
 [% IF show_cardnumber_ops %]
 <li>
 <a class="batch_op send_to_patron_mod" data-placement="right" data-submit="batch_patron_modification" data-toggle="tooltip" href="#" title="إرسال النتائج المرئية إلى تعديل المستفيد بالدفعة">تعديل المستفيد بالدفعة</a>
 </li>
 [% END %]
 [% IF show_borrowernumber_ops %]
 <li>
 <a class="batch_op send_to_patron_card_batch" data-placement="right" data-submit="patron_card_creator" data-toggle="tooltip" href="#" title="إرسال النتائج المرئية إلى دفعة بطاقة المستفيد الجديدة">منشئ بطاقات المستفيدين</a>
 </li>
 [% END %]
 [% END %]
 [% FOREACH header_ro IN header_row %]
 [% IF header_ro.has_biblionumbers && ( header_ro.cell == 'biblionumber' || header_types.item( header_ro.cell ) == 'biblionumber' ) %]
 <li class="dropdown-header">التسجيلات الببليوغرافية</li>
 <li>
 <a class="batch_op send_to_record_mod" data-placement="right" data-submit="batch_record_modification" data-toggle="tooltip" href="#" title="إرسال التسجيلات المرئية إلى تعديل التسجيلات بالدفعة">تعديل التسجيلة بالدفعة</a>
 </li>
 <li>
 <a class="batch_op send_to_record_del" data-placement="right" data-submit="batch_record_deletion" data-toggle="tooltip" href="#" title="إرسال التسجيلات المرئية إلى حذف التسجيلات بالدفعة">حذف التسجيلات بالدفعة</a>
 </li>
 <li>
 <a class="batch_op send_to_list" data-placement="right" data-submit="batch_add_to_list" data-toggle="tooltip" href="#" title="إرسال التسجيلات المرئية إلى قائمة">إضافة إلى القائمة</a>
 </li>
 [% END %]
 [% IF header_ro.has_itemnumbers && ( header_ro.cell == 'itemnumber' || header_types.item( header_ro.cell ) == 'itemnumber' ) %]
 <li class="dropdown-header">تسجيلات المواد</li>
 <li>
 <a class="batch_op send_to_item_mod" data-placement="right" data-submit="batch_item_modification" data-toggle="tooltip" href="#" title="إرسال المواد المرئية إلى تعديل المواد بالدفعة">تعديل المواد بالدفعة</a>
 </li>
 <li>
 <a class="batch_op send_to_item_del" data-placement="right" data-submit="batch_item_deletion" data-toggle="tooltip" href="#" title="إرسال المواد المرئية إلى حذف المواد بالدفعة">حذف المواد بالدفعة</a>
 </li>
 [% END %]
 [% END # /FOREACH header_ro %]
 </ul> <!-- /.dropdown-menu -->
 </div> <!-- /.dropdown -->
 [% END # /IF ( batch_biblionumbers || batch_itemnumbers || batch_cardnumbers ) %]

 [% IF ( unlimited_total > 10 && limit <= 1000 ) %]
 <div class="btn-group">
 <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
 [% IF ( limit ) %] الصفوف لكل صفحة: <strong>[% limit | html %]</strong>
 [% ELSE %] الصفوف لكل صفحة [% END %] <span class="caret"></span>
 </button>
 <ul class="dropdown-menu">
 [% limits = [ 10, 20, 50, 100, 200, 300, 400, 500, 1000 ] %]
 [% FOREACH l IN limits %]
 [% IF l == limit %]
 <li>
 <a class="limitselect" data-limit="[% l | html %]" href="#"><i class="fa fa-fw fa-check"></i> [% l | html %]</a>
 </li>
 [% ELSE %]
 <li>
 <a class="limitselect" data-limit="[% l | html %]" href="#"><i class="fa fa-fw"></i> [% l | html %]</a>
 </li>
 [% END %]
 [% END %]
 </ul>
 </div>
 [% END # /IF ( unlimited_total > 10 && limit <= 1000 ) %]

 [% IF ( batch_biblionumbers || batch_itemnumbers || batch_cardnumbers ) %]
 <a href="#" class="btn btn-link" id="toggle_auto_links">
 <i class="fa-solid fa-eye autolink" style="display:none"></i>
 <i class="fa-solid fa-eye-slash autolink"></i>
 <span class="autolink" style="display:none">عرض قوائم البيانات</span>
 <span class="autolink">إخفاء قوائم البيانات</span>
 </a>
 [% END %]
 </div> <!-- /#toolbar.btn-toolbar -->
 [% END # /IF batch operations || ( unlimited_total > 10 && limit <= 1000 ) %]

 <div class="pages">
 [% pagination_bar | $raw %]
 </div>

 [% END # UNLESS ( errors ) %]
 [% END # IF ( execute ) %]

 [% UNLESS ( errors ) %]
 <table id="report_results">
 <thead>
 <tr>
 [% FOREACH header_ro IN header_row %]
 [% IF header_ro.has_itemnumbers && ( header_ro.cell == 'itemnumber' || header_types.item( header_ro.cell ) == 'itemnumber' ) %]
 <th class="itemnumber">[% header_ro.cell | html %]</th>
 [% ELSIF header_ro.has_biblionumbers && ( header_ro.cell == 'biblionumber' || header_types.item( header_ro.cell ) == 'biblionumber' ) %]
 <th class="biblionumber">[% header_ro.cell | html %]</th>
 [% ELSIF header_ro.cell == 'cardnumber' || header_types.item( header_ro.cell ) == 'cardnumber' %]
 <th class="cardnumber">[% header_ro.cell | html %]</th>
 [% ELSIF header_ro.cell == 'borrowernumber' || header_types.item( header_ro.cell ) == 'borrowernumber' %]
 <th class="borrowernumber">[% header_ro.cell | html %]</th>
 [% ELSE %]
 <th>[% header_ro.cell | html %]</th>
 [% END %]
 [% END %]
 </tr>
 </thead>
 <tbody>
 [% FOREACH result IN results %]
 <tr>
 [% FOREACH cells IN result.cells %]
 [% place = loop.index %]
 [%- IF header_row.$place.cell == 'itemnumber' || header_types.item(header_row.$place.cell) == 'itemnumber' %]
 <td class="batch-op itemnumber" data-number="itemnumber">
 <span class="data-plain">[% cells.cell | $raw %]</span>
 <div id="itemnumber_autolink" class="btn-group dropup autolink"><a class="btn btn-link dropdown-toggle" role="button" data-toggle="dropdown" href="#">[% cells.cell | $raw %] <b class="caret"></b></a>
 <ul class="dropdown-menu pull-right" role="menu">
 <li><a target="_blank" href="/cgi-bin/koha/cataloguing/additem.pl?op=edititem&itemnumber=[% cells.cell | $raw %]"><i class="fa-fw fa-solid fa-pencil" aria-hidden="true"></i> تحرير التسجيلة</a></li>
 <li role="separator" class="divider"></li>
 <li><a target="_blank" href="/cgi-bin/koha/catalogue/moredetail.pl?itemnumber=[% cells.cell | $raw %]"><i class="fa fa-fw fa-eye"></i> عرض التسجيلة</a></li>
 </ul>
 </div>
 </td>
 [% ELSIF header_row.$place.cell == 'biblionumber' || header_types.item(header_row.$place.cell) == 'biblionumber' %]
 <td class="batch-op biblionumber" data-number="biblionumber">
 <span class="data-plain">[% cells.cell | $raw %]</span>
 <div id="biblionumber_autolink" class="btn-group dropup autolink"><a class="btn btn-link dropdown-toggle" role="button" data-toggle="dropdown" href="#">[% cells.cell | $raw %] <b class="caret"></b></a>
 <ul class="dropdown-menu pull-right" role="menu">
 <li><a target="_blank" href="/cgi-bin/koha/cataloguing/addbiblio.pl?biblionumber=[% cells.cell | $raw %]"><i class="fa-solid fa-pencil" aria-hidden="true"></i> تحرير التسجيلة</a></li>
 <li role="separator" class="divider"></li>
 <li><a target="_blank" href="/cgi-bin/koha/catalogue/detail.pl?biblionumber=[% cells.cell | $raw %]"><i class="fa-solid fa-eye"></i> عرض التسجيلة</a></li>
 </ul>
 </div>
 </td>
 [% ELSIF header_row.$place.cell == 'borrowernumber' || header_types.item(header_row.$place.cell) == 'borrowernumber' %]
 <td class="batch-op borrowernumber" data-number="borrowernumber">
 <span class="data-plain">[% cells.cell | $raw %]</span>
 <div id="borrowernumber_autolink" class="btn-group dropup autolink"><a class="btn btn-link dropdown-toggle" role="button" data-toggle="dropdown" href="#">[% cells.cell | $raw %] <b class="caret"></b></a>
 <ul class="dropdown-menu pull-right" role="menu">
 <li><a target="_blank" href="/cgi-bin/koha/members/moremember.pl?borrowernumber=[% cells.cell | $raw %]"><i class="fa-solid fa-eye"></i> عرض المستفيد</a></li>
 <li role="separator" class="divider"></li>
 <li><a target="_blank" href="/cgi-bin/koha/members/memberentry.pl?op=edit_form&amp;borrowernumber=[% cells.cell | $raw %]"><i class="fa-solid fa-pencil" aria-hidden="true"></i> تحرير المستفيد</a></li>
 <li role="separator" class="divider"></li>
 <li><a target="_blank" href="/cgi-bin/koha/circ/circulation.pl?borrowernumber=[% cells.cell | $raw %]"><i class="fa fa-barcode"></i> إعارة</a></li>
 </ul>
 </div>
 </td>
 [% ELSIF header_row.$place.cell == 'cardnumber' || header_types.item(header_row.$place.cell) == 'cardnumber' %]
 <td class="batch-op cardnumber" data-number="cardnumber">
 <span class="data-plain">[% cells.cell | $raw %]</span>
 <div id="cardnumber_autolink" class="btn-group dropup autolink"><a class="btn btn-link dropdown-toggle" role="button" data-toggle="dropdown" href="#">[% cells.cell | $raw %] <b class="caret"></b></a>
 <ul class="dropdown-menu pull-right" role="menu">
 <li><a target="_blank" href="/cgi-bin/koha/circ/circulation.pl?findborrower=[% cells.cell | $raw %]"><i class="fa fa-barcode"></i> إعارة</a></li>
 </ul>
 </div>
 </td>
 [% ELSE %]
 <td>
 [% cells.cell | $raw %]
 </td>
 [% END %]
 [% END %]
 </tr>
 [% END %]
 </tbody>
 </table>
 [% END %]
 <div class="pages">[% pagination_bar | $raw %]</div>
 </div>
 [% INCLUDE 'chart.inc' %]

 [% END #/IF ( execute ) %]

 [% IF ( create ) %]
 <h1>إنشاء من SQL</h1>
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="post" id="sql_report_form">
 [% INCLUDE 'csrf-token.inc' %]
 <fieldset class="rows">
 <legend>إنشاء تقرير من SQL</legend>
 <ol>
 <li>
 <label for="reportname" class="required">اسم التقرير:</label>
 [% IF ( reportname ) %]
 <input type="text" class="required" required="required" id="reportname" name="reportname" value="[% reportname | html %]" size="50"/>
 [% ELSE %]
 <input type="text" class="required focus" required="required" id="reportname" name="reportname" size="50" />
 [% END %]
 <span class="required">مطلوب</span>
 </li>
 [% PROCESS group_and_subgroup_selection %]

 [% IF (public) %]
 <li>
 <label for="public">التقرير عام:</label>
 <select id="public" name="public">
 <option value="0">لا (افتراضي)</option>
 <option value="1" selected="selected">نعم</option>
 </select>
 </li>
 [% ELSE %]
 <li>
 <label for="public">التقرير عام:</label>
 <select id="public" name="public">
 <option value="0" selected="selected">لا (افتراضي)</option>
 <option value="1">نعم</option>
 </select>
 </li>
 [% END # /IF (public) %]

 [% IF (usecache) %]
 <li>
 <label for="cache_expiry">انتهاء التخبأة:</label>
 <input type="text" id="cache_expiry" name="cache_expiry" value="[% cache_expiry | html %]"></input>
 <select id="cache_expiry_units" name="cache_expiry_units">
 <option value="seconds" selected="selected">ثوانٍ (الافتراضي)</option>
 <option value="minutes">دقائق</option>
 <option value="hours">ساعات</option>
 <option value="days">أيام</option>
 </select>
 </li>
 [% END # /IF (usecache) %]
 <li>
 <label for="notes">ملاحظات:</label>
 <textarea id="notes" name="notes" cols="50" rows="2">[% notes | html %]</textarea>
 </li>
 </ol>
 </fieldset> <!-- /.rows -->

 <fieldset class="rows">
 <legend>SQL:</legend>
 <div style="margin:1em;">
 [% PROCESS insert_runtime_parameter  %]
 <textarea id="sql" name="sql" class="required" required="required" cols="50" rows="10" >[% sql | html %]</textarea>
 <span style='color:#383838; font-style:italic'>* من أجل تحقيق الإكمال التلقائي للأعمدة، يرجى إضافة اسم العمود إلى اسم الجدول، متبوعاً بنقطة. على سبيل المثال: 'borrowers.surname'</span>
 <br/>
 <span class="required">مطلوب</span>
 </div>
 </fieldset>

 <fieldset class="action">
 <input type="hidden" name="op" value="cud-save" />
 <input class="btn btn-primary" name="submit" type="submit" value="حفظ التقرير" />
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=list" class="cancel">إلغاء</a>
 </fieldset>

 </form>
 [% END #/IF ( create ) %]

 [% IF saved_results %]
 <h1>نتائج التقرير محفوظة</h1>
 <h2>[% name | html %]</h2>
 <p>[% notes | html %]</p>
 <table>
 [% FOREACH rows IN saved_results %]
 <tr>
 [% FOREACH col IN rows %]
 <td>[% col | html %]</td>
 [% END %]
 </tr>
 [% END %]
 </table>
 [% END # /IF saved_results %]

 [% IF ( showsql ) %]
 <h1>تقارير محفوظة - SQL</h1>
 <fieldset class="rows">
 <legend>[% reportname | html %]</legend>
 <ol>
 [% IF ( notes ) %]
 <li>
 <span class="label">ملاحظات:</span>
 [% notes | html %]
 </li>
 [% ELSE %]
 [% END %]
 <li>
 <textarea id="sql">[% sql | html %]</textarea>
 </li>
 </ol>
 </fieldset>
 [% END # /IF ( showsql ) %]

 [% IF ( save_successful ) %]
 [% UNLESS ( errors ) %]
 </br>
 <div id="report_updated">
 <div class="dialog message">
 <p>تم حفظ تقريرك "[% reportname | html %]"</p>
 </div>
 </div>
 [% END %]
 [% END %]

 [% IF ( editsql ) %]
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="post" id="sql_report_form">
 [% INCLUDE 'csrf-token.inc' %]
 <input type="hidden" name="id" value="[% id | html %]"/>
 <fieldset class="rows">
 <legend><h1>تحرير تقارير SQL</h1></legend>
 <ol>
 <li>
 <label for="reportname" class="required">اسم التقرير: </label>
 <input type="text" id="reportname" name="reportname" value="[% reportname | html %]" size="50" class="required" required="required" />
 <span class="required">مطلوب</span>
 </li>
 [% PROCESS group_and_subgroup_selection %]
 [% IF (public) %]
 <li>
 <label for="public">التقرير عام:</label>
 <select id="public" name="public">
 <option value="0">لا (افتراضي)</option>
 <option value="1" selected="selected">نعم</option>
 </select>
 </li>
 [% ELSE %]
 <li>
 <label for="public">التقرير عام:</label>
 <select id="public" name="public">
 <option value="0" selected="selected">لا (افتراضي)</option>
 <option value="1">نعم</option>
 </select>
 </li>
 [% END # /IF (public) %]

 [% IF (usecache) %]
 <li>
 <label for="cache_expiry">انتهاء التخبأة:</label>
 <input type="text" id="cache_expiry" name="cache_expiry" value="[% cache_expiry | html %]" />
 <select id="cache_expiry_units" name="cache_expiry_units">
 <option value="seconds">ثوانٍ (الافتراضي)</option>
 <option value="minutes">دقائق</option>
 <option value="hours">ساعات</option>
 <option value="days">أيام</option>
 </select>
 </li>
 [% END %]
 <li>
 <label for="notes">ملاحظات:</label>
 <textarea id="notes" name="notes" cols="50" rows="2">[% notes | html %]</textarea>
 </li>
 </ol>
 </fieldset> <!-- /.rows -->

 <fieldset class="rows">
 <legend>SQL:</legend>
 [% PROCESS insert_runtime_parameter  %]
 <textarea id="sql" name="sql" class="required" required="required" cols="50" rows="10">[% sql | html %]</textarea>
 <span style='color:#383838; font-style:italic'>* من أجل تحقيق الإكمال التلقائي للأعمدة، يرجى إضافة اسم العمود إلى اسم الجدول، متبوعاً بنقطة. على سبيل المثال: 'borrowers.surname'</span>
 <br/>
 <span class="required" style="margin-left:30px;">مطلوب</span>
 </fieldset>

 <fieldset class="action">
 <button class="btn btn-primary" type="submit" name="op" value="cud-update_sql">تحديث SQL</button>
 <button class="btn btn-default" type="submit" name="op" value="cud-update_and_run_sql">تحديث وتشغيل SQL</button>
 <a href="/cgi-bin/koha/reports/guided_reports.pl?op=list" class="cancel">إلغاء</a>
 </fieldset>
 </form>
 [% END # /IF ( editsql ) %]

 [% IF ( errors ) %]
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="get">
 <div class="dialog alert">
 <strong>تمت مواجهة الخطأ التالي:</strong><br />
 [% FOREACH error IN errors %] [% IF ( error.sqlerr ) %] يحتوي هذا التقرير على كلمة SQL المفتاحية <strong>[% error.sqlerr | html %]</strong>.<br />
 استخدام هذه الكلمة المفتاحية غير مسموح به في تقارير كوها بسبب مخاطر أمنية تتعلق بسلامة البيانات. استعلامات SELECT هي المتاحة فقط.<br />
 يرجى العودة إلى شاشة &quot;التقارير المحفوطة&quot; وحذف هذا التقرير أو أعد محاولة إنشاء تقرير جديد. [% ELSIF ( error.queryerr ) %] <span>أعادت قاعدة البيانات الخطأ التالي:</span> <br />
 [% error.queryerr | html %]<br />Please check the log for further details.
 [% ELSIF ( error.cache_expiry ) %]
 Please select a cache expiry less than 30 days.
 [% ELSIF ( error.passworderr ) %]
 The column selection in this report includes a password field.<br>
 The report cannot be executed due to security risks.<br>
 Please edit this report and ensure no password columns have been selected.
 [% ELSE %]
 [% END %]
 <div id="onerror_actions">
 <a href="#" class="button goback">العودة إلى الصفحة السابقة</a>
 </div>
 [% END %]
 </div>
 <fieldset class="action">
 <input type="hidden" name="op" value="list" />
 <input class="btn btn-primary" name="submit" type="submit" value="تقارير محفوظة" />
 </fieldset>
 </form>
 [% END # /IF ( errors ) %]

 </main>
 </div> <!-- /.col-sm-10.col-sm-push-2 -->

 <div class="col-sm-2 col-sm-pull-10">
 <aside>
 [% IF ( saved1 ) %]
 <div id="saved-reports-filter">
 <form action="/cgi-bin/koha/reports/guided_reports.pl" method="get">
 <input type="hidden" name="op" value="list" />
 <input type="hidden" name="filter_set" value="1" />
 <fieldset class="brief">
 <h3>تنقيح</h3>
 <ol>
 <li>
 <label for="filter_date">التاريخ:</label>
 <input type="text" id="filter_date" name="filter_date" size="10" value="[% filters.date | html %]" class="flatpickr" />
 <div class="hint">[% INCLUDE 'date-format.inc' %]</div>
 </li>
 <li>
 <label for="filter_author">المؤلف:</label>
 <input type="text" id="filter_author" name="filter_author" value="[% filters.author | html %]" size="16" />
 </li>
 <li>
 <label for="filter_keyword">كلمة مفتاحية:</label>
 <input type="text" id="filter_keyword" name="filter_keyword" value="[% filters.keyword | html %]" size="16" />
 </li>
 </ol>
 </fieldset> <!-- /.brief -->
 <fieldset class="action">
 <input class="btn btn-primary" type="submit" value="تطبيق المنقح" />
 <a id="resetReportsFilter" href="/cgi-bin/koha/reports/guided_reports.pl?op=list&clear_filters=1">مسح</a>
 </fieldset>
 </form>
 </div> <!-- /#saved-reports-filter -->
 [% END %]
 [% INCLUDE 'guided-reports-view.inc' %]
 </aside>
 </div> <!-- /.col-sm-2.col-sm-pull-10 -->
 </div> <!-- /.row -->

 <!-- Runtime Parameters Modal -->
 <div class="modal" id="runtime_parameters" tabindex="-1" role="dialog" aria-labelledby="runtime_parametersLabel">
 <div class="modal-dialog" role="document">
 <div class="modal-content">
 <div class="modal-header">
 <button aria-label="إغلاق" class="closebtn" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
 <h4 class="modal-title" id="runtime_parametersLabel">خيارات معامل وقت التشغيل</h4>
 </div>
 <form method="get" id="send_runtime_parameter">
 <input type="hidden" name="param_category" id="param_category" />
 <div class="modal-body">
 <div class="form-group">
 <label for="paramLabel" class="required">ملصق المعامل: </label>
 <input class="form-control required" type="text" name="paramLabel" id="paramLabel" required="required" />
 <div class="hint">ملصق تسمية الحقل الذي يظهر عند تشغيل التقرير، على سبيل المثال: "حدد مكتبة."</div>
 </div>
 <div id="authorised_value_category" class="form-group" style="display:none">
 <label for="authorised_value">فئة قيمة الاستناد:</label>
 <select class="form-control" name="authorised_value" id="authorised_value">
 <option value=""></option>
 [% PROCESS options_for_authorised_value_categories authorised_value_categories => AuthorisedValues.GetCategories() %]
 </select>
 <div class="hint">حدد فئة قيم الاستناد التي سيختار المستخدم منها.</div>
 </div>
 <div id="runtime_param_options" style="display:none">
 <h5>Parameter options:</h5>
 <div class="radio">
 <input type="radio" id="single_param_check" name="param_option" value="" checked="checked" />
 <label for="single_param_check">Single parameter only</label>
 <span class="hint">- Query expression should use =</span>
 </div>

 <div class="radio">
 <input type="radio" id="include_all_check" name="param_option" value=":all">
 <label for="include_all_check">Include option for all</label>
 <span class="hint">- Query expression must use LIKE</span>
 </div>

 <div class="radio">
 <input type="radio" id="multi_select_check" name="param_option" value=":in">
 <label for="multi_select_check">Allow multiple selections</label>
 <span class="hint">- Query expression must use IN</span>
 </div>
 </div>
 </div> <!-- /.modal-body -->
 <div class="modal-footer">
 <button type="submit" id="sendParam" class="btn btn-default approve">إدخال معامل</button>
 <button type="button" class="btn btn-default deny" data-dismiss="modal">إلغاء</button>
 </div> <!-- /.modal-footer -->
 </form> <!-- /#send_runtime_parameter -->
 </div> <!-- /.modal-content -->
 </div> <!-- /.modal-dialog -->
 </div> <!-- /#runtime_parameters -->

[% MACRO jsinclude BLOCK %]
 [% Asset.js("js/charts.js") | $raw %]
 [% Asset.js("lib/d3c3/d3.min.js") | $raw %]
 [% Asset.js("lib/d3c3/c3.min.js") | $raw %]
 [% INCLUDE 'calendar.inc' %]
 [% INCLUDE 'datatables.inc' %]
 [% IF ( saved1 ) %]
 [% INCLUDE 'columns_settings.inc' %]
 [% Asset.js( "lib/jsdiff/jsdiff.min.js" ) | $raw %]
 [% END %]
 [% Asset.js( "lib/codemirror/codemirror.min.js" ) | $raw %]
 [% Asset.js( "lib/codemirror/overlay.min.js" ) | $raw %]
 [% Asset.js( "lib/codemirror/sql.js" ) | $raw %]
 [% Asset.js( "lib/codemirror/show-hint.js" ) | $raw %]
 [% Asset.css("lib/codemirror/show-hint.css") | $raw %]
 [% Asset.js( "lib/codemirror/sql-hint.js" ) | $raw %]
 [% Asset.js( "lib/codemirror/highlight.js" ) | $raw %]
 [% Asset.css("lib/codemirror/highlight.css") | $raw %]
 [% Asset.js( "js/mana.js" ) | $raw %]

 <script>

        //  if the report param form has multiselects override default form submission
        if( $('#report_param_form').find('select[multiple]').length ) {
            $('#report_param_form').find('select[multiple]').each( function (i) {
                $(this).on('change', function() {
                    var $selected = $(this).val().join('\n');
                    $(this).find('option:first').val($selected);
                });
            });

            $('#report_param_form').on('submit', function(e) {
                $('#report_param_form').find('select[multiple]').each( function (i) {
                    var $selected = $('option:first', this).val();
                    $(this).val($selected);
                });
            });
        }

        function hide_bar_element() {
            $('#chart-column-horizontal').hide()
            $('.chart-column-group').each(function( index ) {
                $( this ).hide();
            });
            $('.chart-column-line').each(function( index ) {
                $( this ).hide()
            });
        }

        function show_bar_element() {
            $('#chart-column-horizontal').show()
            $('.chart-column-group').each(function( index ) {
                $( this ).show()
            });
            $('.chart-column-line').each(function( index ) {
                $( this ).show()
            });
        }

        function removeColumn(id) {
            $('#'+id).remove();

            if ( $('.chart-column-conf').length == 1 ) {
                $('.chart-column-delete').remove();
            }
        }

        var MSG_CONFIRM_DELETE = _("هل أنت متأكد من أنك تريد حذف هذا التقرير؟ هذا الإجراء لا يمكن التراجع عنه.");
        var group_subgroups = {};
        [% FOREACH group IN groups_with_subgroups %]
            var gid = "[% group.id | html %]"
            group_subgroups[gid] = new Array();
            [% FOREACH subgroup IN group.subgroups %]
                var sgid = "[% subgroup.id | html %]";
                var sgname = "[% subgroup.name | html %]";
                group_subgroups[gid].push([sgid, sgname]);
            [% END %]
        [% END %]

        [% IF ( create || editsql || save ) %]

            var editor = CodeMirror.fromTextArea(sql, {
                lineNumbers: true,
                mode: "text/x-sql",
                lineWrapping: true,
                smartIndent: false,
                keyword: { // Custom highlighting for items bounded in [[ ]] or << >>.
                    "\\[\\[(.*?)\\]\\]":"style1",
                    "<<(.*?)>>":"style1"
                },
                hint: CodeMirror.hint.sql,
                hintOptions: {
                    tables: [% To.json(tables) | $raw %]
                }
            });
            var ExcludedTriggerKeys = { //key-code combinations of keys that will not fire the auto-complete script
                "8": "backspace",
                "9": "tab",
                "13": "enter",
                "16": "shift",
                "17": "ctrl",
                "18": "alt",
                "19": "pause",
                "20": "capslock",
                "27": "escape",
                "33": "pageup",
                "32": "spacebar",
                "34": "pagedown",
                "35": "end",
                "36": "home",
                "37": "left",
                "38": "up",
                "39": "right",
                "40": "down",
                "45": "insert",
                "46": "delete",
                "56": "asterisk",
                "59": "semicolon",
                "91": "left window key",
                "92": "right window key",
                "93": "select",
                "106": "asterisk",
                "107": "add",
                "109": "subtract",
                "110": "decimal point",
                "111": "divide",
                "112": "f1",
                "113": "f2",
                "114": "f3",
                "115": "f4",
                "116": "f5",
                "117": "f6",
                "118": "f7",
                "119": "f8",
                "120": "f9",
                "121": "f10",
                "122": "f11",
                "123": "f12",
                "144": "numlock",
                "145": "scrolllock",
                "186": "semicolon",
                "187": "equalsign",
                "188": "comma",
                "189": "dash",
                "191": "slash",
                "192": "graveaccent",
                "220": "backslash",
                "222": "quote"
            }
            //Trigger auto-complete on all keys not in dictionary of exclusions above.
            editor.on("keyup", function(cm, e) {
                if (ExcludedTriggerKeys[e.keyCode] == undefined) {
                         CodeMirror.commands.autocomplete(editor, null, { completeSingle: false });
                }
            })

           // https://stackoverflow.com/questions/2086287/how-to-clear-jquery-validation-error-messages#answer-16025232
            function clearValidation( formElement ){
                // formElement should be a jQuery object
                var validator = formElement.validate();
                // Iterate through named elements inside of the form, and mark them as error free
                $('[name]',formElement).each(function(){
                    validator.successList.push(this);//mark as error free
                    validator.showErrors();//remove error messages if present
                });
                validator.resetForm();//remove error class on name elements and clear history
                validator.reset();//remove all error and success data
            }
        [% END %]

        [% IF ( showsql ) %]

            var editor = CodeMirror.fromTextArea(sql, {
                lineNumbers: false,
                mode: "text/x-sql",
                lineWrapping: true,
                readOnly: true,
                keyword: { // Custom highlighting for items bounded in [[ ]] or << >>.
                    "\\[\\[(.*?)\\]\\]":"style2",
                    "<<(.*?)>>":"style1"
               },
            });
        [% END %]

        function showParamModal( category ){
            var modal = $("#runtime_parameters");
            var modalTitle = $("#runtime_parametersLabel");
            switch ( category ){
                case "insertAuthVal":
                    modalTitle.text( _("إدخال معامل قيمة الاستناد") );
                    $("#paramLabel").val( _("قيمة الاستناد") );
                    $("#authorised_value_category").show();
                    $("label[for='authorised_value']").addClass("required");
                    $("#authorised_value").prop("required", true ).attr("required", "required").addClass("required");
                    $("#runtime_param_options").show();
                    break;
                case "insertCnSource":
                    modalTitle.text( _("إدخال معامل مصدر التصنيف") );
                    $("#paramLabel").val( _("مصدر التصنيف أو مخطط الترفيف") );
                    $("#param_category").val("cn_source");
                    $("#runtime_param_options").show();
                    break;
                case "insertFramework":
                    modalTitle.text( _("إدخال معامل إطار مارك الببليوغرافي") );
                    $("#paramLabel").val( _("إطار") );
                    $("#param_category").val("biblio_framework");
                    $("#runtime_param_options").show();
                    break;
                case "insertDate":
                    modalTitle.text( _("إدخال معامل التاريخ") );
                    $("#paramLabel").val( _("التاريخ") );
                    $("#param_category").val("date");
                    break;
                case "insertItemtypes":
                    modalTitle.text( _("إدخال معامل نوع المادة") );
                    $("#paramLabel").val( _("نوع المادة") );
                    $("#param_category").val("itemtypes");
                    $("#runtime_param_options").show();
                    break;
                case "insertBranches":
                    modalTitle.text( _("إدخال معامل المكتبات") );
                    $("#paramLabel").val( _("المكتبة") );
                    $("#param_category").val("branches");
                    $("#runtime_param_options").show();
                    break;
                case "insertCategorycode":
                    modalTitle.text( _("إدخال معامل فئة المستفيد") );
                    $("#paramLabel").val( _("فئة المستفيد") );
                    $("#param_category").val("categorycode");
                    $("#runtime_param_options").show();
                    break;
                case "insertCashregister":
                    modalTitle.text( _("إدخال معامل السجل النقدي") );
                    $("#paramLabel").val( _("سجل نقدي") );
                    $("#param_category").val("cash_registers");
                    $("#runtime_param_options").show();
                    break;
                case "insertDebittypes":
                    modalTitle.text( _("إدخال معامل نوع الرصيد المدين") );
                    $("#paramLabel").val( _("نوع الحساب المدين") );
                    $("#param_category").val("debit_types");
                    $("#runtime_param_options").show();
                    break;
                case "insertCredittypes":
                    modalTitle.text( _("إدخال معامل نوع الرصيد الدائن") );
                    $("#paramLabel").val( _("نوع الحساب الدائن") );
                    $("#param_category").val("credit_types");
                    $("#runtime_param_options").show();
                    break;
                case "insertList":
                    modalTitle.text( _("إدخال معامل القائمة") );
                    $("#paramLabel").val( _("قائمة القيم") );
                    $("#param_category").val("list");
                    break;
                case "insertText":
                    modalTitle.text( _("إدخال معامل النص") );
                    $("#paramLabel").val( _("نص") );
                    $("#param_category").val("");
                    break;
            }
            $("#paramLabel").select();
            modal.modal("show");
        }

        function load_group_subgroups () {
            var group = $("#group_select").val();
            var subgroup = $("#subgroup_select").val();
            var sg = $("#subgroup");
            $(sg).find('option[value!=""]').each(function() {
                $(this).remove();
            });
            $(sg).hide();
            if (group) {
                var select = $(sg).find('select')[0];
                $.each( group_subgroups[group], function(index, value) {
                    if ( value[0] == subgroup ) {
                        $('<option selected="selected" value="' + value[0] + '">' + value[1] + '</option>').appendTo(select);
                    } else {
                        $('<option value="' + value[0] + '">' + value[1] + '</option>').appendTo(select);
                    }
                } );
                $("#subgroup, #subgroup *").show();
            }
        }

        $(document).ready(function(){

            var activeTab = localStorage.getItem("sql_reports_activetab");

            $("body").on('click',".fetch_chart_data",function(){
                if( [% unlimited_total || 0 | $raw %] > 1000 ){
                    if( confirm( _("يمكن أن يتسبب جلب بيانات المخطط الكاملة للتقارير التي تحتوي على العديد من الصفوف في حدوث مشكلات في الأداء. هل أنت متأكد أنك تريد رسم هذا التقرير بيانياً؟") ) ){
                        return true;
                    } else {
                        return false;
                    }
                }
            });

            var showsql;
            hide_bar_element();

            if ( $('.chart-column-conf').length == 1 ) {
                $('.chart-column-delete').remove();
            }

            $(".chart-column-delete").on('click', function(e){
                e.preventDefault();
                removeColumn('column_' + $(this).data('column'));
            })

            $('#download-chart').click(function() {
                var svg = '<svg>' + $('#chart svg').html() + '</svg>';
                this.href = 'data:application/octet-stream;base64,' + btoa(svg);
                this.setAttribute('download', 'chart.svg');
            });

            $('#chart-type').change(function() {
                if ($(this).val() == 'bar') {
                    show_bar_element();
                }
                else {
                    hide_bar_element();
                }
            });

            $('#download-chart').hide();
            var chart;

            [% IF results && !errors %]
                $('#draw-chart').click(function() {

                    var x_elements = $('select[name="x"]').val();
                    var y_elements = [];
                    var groups = [];
                    var lines = [];
                    var options = {};

                    headers = [% header_row.json | $raw %];

                    var results;
                    [% IF allresults.size %]
                        if ($('input[name="chart-include-all"]').prop('checked')) {
                            results = [% allresults.json | $raw %]
                        }
                        else {
                            results = [% results.json | $raw %]
                        }
                    [% ELSE %]
                        results = [% results.json | $raw %];
                    [% END %]

                    if ($('input[name="chart-exclude-last"]').prop('checked')) {
                        results.splice(-1, 1);
                    }

                    $('select[name="y"]').each(function( index ) {
                        y_elements.push( $(this).val() );
                    });
                    $('select[name="group"]').each(function( index ) {
                        groups.push( $(this).val() );
                    });
                    $('.column-line').each(function( index ) {
                        if ($(this).prop('checked')) {
                            lines.push( $(this).attr('name') );
                        }
                    });

                    // Remove deleted columns from headers and results.
                    var deleted_indexes = [];
                    var kept_headers = [];
                    $.each(headers, function(index, value) {
                        if (value.cell != x_elements && $.inArray(value.cell, y_elements) === -1) {
                            // This header is neither a x element nor in y elements. Don't need it.
                            deleted_indexes.push(index);
                        }
                        else {
                            kept_headers.push({cell: value.cell});
                        }
                    });

                    // Remove coresponding cells.
                    var kept_results = [];
                    $.each(results, function(index, value) {
                        var line = {};
                        line['cells'] = [];
                        $.each(value.cells, function(i, val) {
                            if ($.inArray(i, deleted_indexes) === -1) {
                                line['cells'].push({cell: val.cell});
                            }
                        });
                        kept_results.push(line);
                    });

                    options.type = $('select[name="chart-type"]').val();
                    options.horizontal = $('input[name="column-horizontal"]').prop('checked');
                    options.lines = lines;

                    chart = create_chart(kept_headers, kept_results, x_elements, y_elements, groups, options);
                    $("#download-chart,#toggle_chart_settings_hid,#chart").show();
                    $("#toggle_chart_settings_vis").hide();
                    $("#chartModal").modal("hide");
                });
            [% END %]
            [% IF ( create ) %]
                load_group_subgroups();
            [% END %]

            $('[data-toggle="tooltip"]').tooltip();

            $('#limit').change(function() {
                $('#limitselect').submit();
            });

            $(document).click(function() {
                $('#report_updated').hide();
            });

            $(".goback").on("click",function(e){
                e.preventDefault();
                window.history.back();
            });

            $("body").on("click", ".mana_search_button", function(){
                $("#mana-loading").show();
                mana_search($("#mana_search_field").val());
            });

            $(".ShareButton").on("click", function(){
                $("#note-error").hide();
                if($(this).closest("tr").find(".report_notes").text().length < 20 || $(this).closest("tr").find(".report_name").text().length < 20){
                    $(".shared_infos").hide();
                    $("#note-error").show();
                }
                else{
                    $("#reportid").val($(this).closest("tr").find(".report_id").text());
                    $("#shared_id").html($(this).closest("tr").find(".report_id").text());
                    $("#shared_name").html($(this).closest("tr").find(".report_name").text());
                    $("#shared_sql").html($(this).closest("tr").find(".report_sql").val());
                    $("#shared_type").html($(this).closest("tr").find(".report_type").text());
                    $("#shared_group").html($(this).closest("tr").find(".report_group").text());
                    $("#shared_notes").html($(this).closest("tr").find(".report_notes").text());
                }
            });

            $("#ManaCloseButton").on("click", function() {
                $(".shared_infos").show();
            });

            $("#addColumn").on("click",function(){
                addColumn();
            });

            $("#delColumn").on("click",function(){
                delColumn();
            });

            [% IF (saved1) %]
                var table_settings = [% TablesSettings.GetTableSettings( 'reports', 'saved-sql', 'table_reports', 'json' ) | $raw %];
                var rtable = KohaTable("table_reports", {
                    "autoWidth": false,
                    "pagingType": 'full',
                    "order": [[ 1, "asc" ]],
                    "language": {
                        "zeroRecords": _("لم يتم العثور على تقارير متطابقة")
                    },

                }, table_settings);

                $("#tabs a[data-toggle='tab']").on("shown.bs.tab", function (e) {
                    tabsInit( $(e.target).parent(), rtable );
                });

                if( activeTab ){
                    $("#tabs li:eq(" + activeTab + ") a").tab("show");
                }

                $("#subgroup_filter").change(function() {
                    var selected = $(this).find('option:selected');
                    var sg_id = $(selected).val();
                    if (sg_id.length > 0) {
                        const input = '^' + $.fn.dataTable.util.escapeRegex(sg_id) + '$';
                        rtable.fnFilter(input, 5, true, false, true, false);
                        rtable.fnSetColumnVis(5, false);
                    } else {
                        rtable.fnFilter('', 5);
                        rtable.fnSetColumnVis(5, true);
                    }
                });

                $("#reports_form").submit(function(){
                    var checkedItems = $("input[name=id]:checked");
                    if ($(checkedItems).size() == 0) {
                        alert(_("يجب عليك تحديد أحد التقارير أو أكثر للحذف"));
                        return false;
                    }
                    $(checkedItems).parents('tr').addClass("warn");
                    if( confirm(_("هل أنت متأكد من أنك تريد حذف التقارير المحددة؟")) ) {
                        return true;
                    } else {
                        $(checkedItems).parents('tr').removeClass("warn");
                        return false;
                    }
                });

                $("body").on("click", ".update_sql", function(e){
                    e.preventDefault();
                    var ltitle = $(this).text();
                    var report_id = $(this).data("report_id");
                    var page = $(this).attr("href");
                    $("#update_sql .modal-body").load(page + " div", function(){
                        var diff1 = $("#col1 .show_sql").text();
                        var diff2 = $("#col2 .show_sql").text();
                        var diffs = diffString( escape(diff1), escape(diff2) );
                        $("#col1 .show_sql,#col2 .show_sql").html(diffs);
                    });
                    $('#update_sql').modal('show');
                    $("#update_sql_button").attr("href", "/cgi-bin/koha/reports/guided_reports.pl?op=convert&id=" + report_id);
                });

                $("#update_sql").on("hidden.bs.modal", function(){
                    $("#update_sql_label").html("");
                    $("#update_sql .modal-body").html("<div id=\"loading\"><img src=\"[% interface | html %]/[% theme | html %]/img/spinner-small.gif\" alt=\"\" /> "+_("جاري التحميل")+"</div>");
                });
            [% END %]

            [% IF ( showsql ) %]
                $("#sql").focus(function() {
                    $(this).select();
                });
            [% END %]

            $("#toggle_sql").click(function(){
                var sql_output = $("#sql_output");
                sql_output.toggle();
                if( sql_output.is(":visible") ){
                    $(this).button('complete');
                } else {
                    $(this).button('reset');
                }
                if( !showsql ){
                    showsql = CodeMirror.fromTextArea(sql, {
                        lineNumbers: false,
                        mode: "text/x-sql",
                        lineWrapping: true,
                        readOnly: true
                    });
                }
            });

            $(".toggle_chart_settings").click(function(){
                $("#chart, #toggle_chart_settings_hid, #toggle_chart_settings_vis").toggle();
            });

            [% IF (create || editsql || save) %]

                var validated_form = $("#sql_report_form").validate({
                    reportname: "required",
                    group_input: {
                        required: {
                            depends: function(element) {
                                return $("#create_group").prop("checked") && $("#groupdesc_input").val() != '';
                            }
                        }
                    },
                    groupdesc_input: {
                        required: {
                            depends: function(element) {
                                return $("#create_group").prop("checked") && $("#group_input").val() != '';
                            }
                        }
                    }
                });

                $("#select_group").change(function() {
                    if($(this).prop('checked')) {
                        $("#group_input").attr("class","").prop('disabled', true).prop("required", false);
                        $("#groupdesc_input").attr("class","").prop('disabled', true).prop("required", false);
                        $("#group_select").prop('disabled', false);
                        clearValidation( $("#sql_report_form") );
                        if ($("#group_select").val().length > 0) {
                            $("#select_subgroup").prop('checked', true);
                            $("#select_subgroup").change();
                            $("#subgroup, #subgroup *").show();
                        } else {
                            $("#subgroup").hide();
                        }
                    }
                });
                $("#create_group").change(function() {
                    if($(this).prop('checked')) {
                        $("#group_input").prop('disabled', false).prop("required", true );
                        $("#groupdesc_input").prop('disabled', false).prop("required", true );
                        $("#group_select").prop('disabled', true);
                        // $("#create_subgroup").prop('checked', true).change();
                        $("#subgroup_select").hide();
                        $("#subgroup input[type='radio']").hide();
                        $("#subgroup label[for]").hide();
                        $("#subgroup_input").prop("required", false ).prop("disabled", false).show();
                        $("#subgroupdesc_input").prop("required", false ).prop("disabled", false).show();
                        $("#subgroup").show();
                        // Add validation rules for fields which were previously hidden
                        $("#subgroup_input").rules("add", {
                            required: {
                                depends: function(element) {
                                    return $("#create_group").prop("checked") &&  $("#subgroupdesc_input").val() != '';
                                }
                            }
                        });
                        $("#subgroupdesc_input").rules("add", {
                            required: {
                                depends: function(element) {
                                    return $("#create_group").prop("checked") &&  $("#subgroup_input").val() != '';
                                }
                            }
                        });
                    }
                });
                $("#select_subgroup").change(function() {
                    if($(this).prop('checked')) {
                        $("#subgroup_select").prop('disabled', false);
                        $("#subgroup_input").prop('disabled', true).prop("required", false );
                        $("#subgroupdesc_input").prop('disabled', true).prop("required", false );
                        clearValidation( $("#sql_report_form") );
                    }
                });
                $("#create_subgroup").change(function() {
                    if($(this).prop('checked')) {
                        $("#subgroup_input").prop('disabled', false).prop("required", true );
                        $("#subgroupdesc_input").prop('disabled', false).prop("required", true );
                        $("#subgroup_select").val("").prop('disabled', true);
                    }
                });
                $("#select_group").change();
                $("#select_subgroup").change();
                $("#group_select").on("change",function(){
                    load_group_subgroups();
                });

                $(".insertParam").on("click", function(e){
                    e.preventDefault();
                    var category = this.id;
                    showParamModal( category );
                });

                $("#runtime_parameters").on("shown.bs.modal", function(){
                    $("#paramLabel").focus();
                });

                $("#runtime_parameters").on("hide.bs.modal", function(){
                    $("#send_runtime_parameter")[0].reset();
                    $("#authorised_value_category").val("").hide();
                    $("#runtime_param_options").val("").hide();
                    $("label[for='authorised_value']").removeClass("required");
                    $("#authorised_value").prop("required", false ).removeAttr("required").removeClass("required");
                });

                $("#send_runtime_parameter").on("submit", function(e){
                    e.preventDefault();
                    /* Get form values */
                    var paramLabel = $("#paramLabel").val();
                    var param_category = $("#param_category").val();
                    var categoryLabel = $("#authorised_value").val();
                    var param_option = $('#runtime_param_options input[name="param_option"]:checked').val();
                    // Get CodeMirror environment variables
                    var selection = editor.getSelection();
                    var doc = editor.getDoc();
                    var cursor = doc.getCursor();
                    var pos = {
                        line: cursor.line,
                        ch: cursor.ch
                    }
                    /* Build runtime parameter text string */
                    var text = "";
                    if( paramLabel && param_category ){
                        text += paramLabel + "|" + param_category;
                    } else if( paramLabel ) {
                        text += paramLabel;
                    } else if( param_category ){
                        text += param_category;
                    }
                    if( param_option ){
                        text += param_option;
                    }
                    if( text != "" ){
                        text = " <<" + text + ">> ";
                        if( selection.length > 0){
                            editor.replaceSelection(text);
                        } else {
                            doc.replaceRange(text, pos);
                        }
                    }
                    $("#runtime_parameters").modal("hide");
                });

                $("#authorised_value").on("change", function(){
                    $("#param_category").val( $(this).val() );
                });

            [% END %]

            $(".delete").on("click",function(e){
                e.preventDefault();
                if ( confirmDelete(MSG_CONFIRM_DELETE) ) {
                    return $(this).siblings('form').submit();
                }
            });

            $("#mana_search_form").submit(function(e){
                e.preventDefault();
            });

            $("#column_submit").submit(function() {
                if ($("#selectedColumns option").size() < 1) {
                    alert(_("لا أعمدة محددة!"));
                    return false;
                }
                $("#selectedColumns option").attr("selected", "selected");  // Select everything still in #selectedColumns
                return true;
            });

            // Mana KB
            $("body").on("click", ".mana-use", function(e) {
                e.preventDefault();
                $(this).find("i").attr("class","fa-solid fa-rotate fa-spin");
                mana_use( $(this).data("report_id") );
            });

            $("#mana_search_result").on("shown.bs.modal", function(){
                $("#mana_search_field").focus();
            });

            $("#mana_search_result").on("hide.bs.modal", function(){
                $("#mana_result_content").html("");
                $("#mana_search_field").val("");
            });

            $(".batch_op").on("click", function(e){
                e.preventDefault();
                var target_form = $(this).data("submit");
                $("#" + target_form ).submit();
            });

            $("#batch_add_to_list").on("submit", function(e){
                e.preventDefault();
                addToList();
            });

            $("body").on("click", ".preview_sql", function(e){
                e.preventDefault();
                var reportid = $(this).data("reportid");
                previewSql( reportid );
            });
            $(".limitselect").on("click", function(){
                var limit = $(this).data("limit");
                $("#limit").val( limit );
                $("#limitselect").submit();
            });
        });

        $("#toggle_auto_links").on("click", function(e){
            e.preventDefault();
            if( $(".data-plain").is(":visible") ){
                /* if a data-plain element is visible, this click hides it and shows auto-links */
                localStorage.removeItem("reports_auto_link_off");
            } else {
                /* if a data-plain element is hidden, this click shows it  and hides auto-links */
                localStorage.setItem("reports_auto_link_off", 1);
            }
            $(".data-plain,.autolink").toggle();
        });
        if ( localStorage.getItem("reports_auto_link_off") == 1 ){
            $("#toggle_auto_links").click();
        }

        function tabsInit( tab, rtable ){
            var activeTab = tab.index();
            localStorage.setItem("sql_reports_activetab", activeTab );

            $("#subgroup_filter option").each(function() {
                if($(this).val().length > 0) {
                    $(this).remove();
                }
            });
            rtable.fnFilter('', 4);
            rtable.fnFilter('', 5);
            rtable.fnSetColumnVis(4, true);
            rtable.fnSetColumnVis(5, true);

            var g_id = tab.find("a").data("tabname");
            if (g_id === 'reports') {
                g_id = '';
            }

            if (g_id && g_id.length > 0) {
                const input = '^' + $.fn.dataTable.util.escapeRegex(g_id) + '$';
                rtable.fnFilter(input, 4, true, false, true, false);
                rtable.fnSetColumnVis(4, false);
                for(var i in group_subgroups[g_id]) {
                    $("#subgroup_filter").append(
                        '<option value="' + group_subgroups[g_id][i][0] + '">'
                        + group_subgroups[g_id][i][1] + '</option>'
                    );
                }
                $("#subgroup_filter_block").show();
            } else {
                $("#subgroup_filter_block").hide();
            }
        }

        function addColumn() {
            $("#availableColumns option:selected").clone().appendTo("#selectedColumns").attr("selected", "selected");
        }
        function delColumn() {
            $("#selectedColumns option:selected").remove();
        }

        // Mana KB
        function mana_use( mana_id ){
            $.ajax( {
                type:"POST",
                url: "/cgi-bin/koha/svc/mana/use",
                data: {id:mana_id, resource: 'report', saveinbase: 1, csrf_token: $('meta[name="csrf-token"]').attr('content')},
                dataType: "json",
            })
            .done( function (result){
                if ( result.errmsg ){
                    alert( result.errmsg );
                }
                else{
                    window.location = ("/cgi-bin/koha/reports/guided_reports.pl?id=").concat(result.id).concat("&op=show&mana_success=1");
                }
            })
            .fail(function( error ) {
                $(".mana_use_status").hide();
                $("#mana_use_errortext").html( error.status + " " + error.statusText );
                $("#mana_use_failed").show();
                $(".mana-use i").attr("class","fa fa-download");
            });
        }

        function mana_search( textquery ){
            $(".mana_search_status").hide();
            $("#mana_result_content").load("/cgi-bin/koha/svc/mana/search #mana_results", { resource: 'report', id: textquery, usecomments: 1 }, function( response, status, xhr ) {

                    if ( status == "error" ) {
                        $("#mana_search_errortext").html( xhr.status + " " + xhr.statusText );
                        $("#mana_search_failed").show();
                        $("#mana-loading").hide();
                    } else {
                        $(".mana_search_status").hide();
                        $("#mana_search_result_label").text(_("النتائج من قاعدة معرفة مانا"));
                        $("#mana-loading").hide();
                        $("#mana_results_datatable").dataTable($.extend(true, {}, dataTablesDefaults,{
                            "pagingType": "full",
                            "autoWidth": false,
                            "columnDefs": [
                                { "width": "35%", "targets": 1 }
                            ],
                            "columnDefs": [
                                { "orderable": false, "searchable":  false, "targets": [ 'NoSort' ] },
                                { "type": "anti-the", "targets":  [ 'anti-the'] }
                            ]
                        }));

                        $(".showbutton").on("click", function(e){
                            e.preventDefault();
                            $(this).parent().hide();
                            $(this).parent().next().show();
                        });

                        $(".hidebutton").on("click", function(e){
                            e.preventDefault();
                            $(this).parent().hide();
                            $(this).parent().prev().show();
                        });

                        if($("td.dataTables_empty").length == 0){
                            $("#mana_search_message").show();
                        }
                    }
                });
        }

        function addToList() {
            var biblionumbers = [];
            $(".bib_to_list").each(function() {
                var biblionumber = Number( $(this).val() );
                if( biblionumbers.indexOf( biblionumber ) < 0 ){
                    biblionumbers.push( biblionumber );
                }
            });
            bibs = biblionumbers.join("/");
            var url = "/cgi-bin/koha/virtualshelves/addbybiblionumber.pl?biblionumbers=" + bibs;
            window.open(url, 'Add_to_virtualshelf', 'width=500, height=400, toolbar=false, scrollbars=yes');
            return false;
        }

        // Adapted from https://gist.github.com/jnormore/7418776
        function previewSql(reportid) {
            var yes_label = "";
            var no_label = "";
            var message = $("#previewSql" + reportid ).val();
            var title = $("#previewSql" + reportid ).data("title");
            if( $("#preview-sql-modal").length > 0) {
                $("#preview-sql-modal").remove();
            }
            $("body").append('<div id="preview-sql-modal" tabindex="-1" role="dialog" aria-hidden="true" class="modal">\
                <div class="modal-dialog">\
                    <div class="modal-content">\
                        <div class="modal-header" style="min-height:40px;">\
                            <button type="button" class="closebtn" data-dismiss="modal" aria-label="Close">\
                                <span aria-hidden="true">×</span>\
                            </button>\
                            <h4 class="modal-title">' + title + '</h4>\
                        </div>\
                        <div class="modal-body"><textarea id="code' + reportid + '">' + message + '</textarea>\
                        </div>\
                        <div class="modal-footer">\
                            <a id="preview-modal-editreport" class="btn btn-default" href="/cgi-bin/koha/reports/guided_reports.pl?id=' + reportid + '&amp;op=edit_form"><i class="fa-solid fa-pencil" aria-hidden="true"></i> ' + _("تحرير") + '</a>\
                            <a id="preview-modal-duplicate" class="btn btn-default" href="/cgi-bin/koha/reports/guided_reports.pl?op=duplicate&amp;id=' + reportid + '"><i class="fa fa-copy"></i> ' + _("نسخ") + '</a>\
                            <a id="preview-modal-duplicate" class="btn btn-default" href="/cgi-bin/koha/tools/scheduler.pl?id=' + reportid + '"><i class="fa-solid fa-clock"></i> ' + _("الجداول") + '</a>\
                            <form method="post" action="/cgi-bin/koha/reports/guided_reports.pl">\
                                [% INCLUDE 'csrf-token.inc' | collapse %]\
                                <input type="hidden" name="op" value="cud-delete" />\
                                <input type="hidden" name="id" value="' + reportid + '" />\
                            </form>\
                            <a id="preview-modal-delete"href="#" class="btn btn-default" title="Delete this saved report"><i class="fa fa-trash-can"></i> ' + _("Delete") + '</a>\
                            <a id="preview-modal-runreport" class="btn btn-default" href="/cgi-bin/koha/reports/guided_reports.pl?id=' + reportid + '&amp;op=run"><i class="fa fa-play"></i> ' + _("Run report") + '</a>\
                            <a href="#" id="preview-sql-modal-cancel" data-dismiss="modal" class="btn btn-default"><i class="fa fa-times" aria-hidden="true"></i> ' + _("Close") + '</a>\
                        </div>\
                    </div>\
                </div>\
            </div>');

            $("#preview-sql-modal").modal('show');
            CodeMirror.fromTextArea( document.getElementById("code" + reportid ), {
                lineNumbers: false,
                mode: "text/x-sql",
                lineWrapping: true,
                readOnly: true
            });
            $("#preview-modal-delete").on("click",function(e){
                e.preventDefault();
                if ( confirmDelete(MSG_CONFIRM_DELETE) ) {
                    return $(this).siblings('form').submit();
                }
            });

        }
    </script>
[% END %]

[% INCLUDE 'intranet-bottom.inc' %]

[% BLOCK group_and_subgroup_selection %]
 <li id="group">
 <label>مجموعة التقرير:</label>
 <input type="radio" name="select_or_create_group"
            id="select_group" checked="checked" />
 <label for="select_group" class="radio">تحديد</label>
 <select name="group" id="group_select">
 <option value="">(لا شيء)</option>
 [% FOREACH group IN groups_with_subgroups %]
 [% IF (group.selected) %]
 <option value="[% group.id | html %]" selected="selected">
 [% ELSE %]
 <option value="[% group.id | html %]">
 [% END %]
 [% group.name | html %]
 </option>
 [% END %]
 </select>
 <input type="radio" name="select_or_create_group" id="create_group" />
 <label for="create_group" class="radio">أو قم بإنشاء:</label>
 <input id="group_input" name="group" placeholder="رمز" title="رمز المجموعة" type="text" />
 <input id="groupdesc_input" name="groupdesc" placeholder="الاسم" title="اسم المجموعة" type="text" />
 </li>
 <li id="subgroup">
 <label>مجموعة التقرير الفرعية:</label>
 <input type="radio" name="select_or_create_subgroup"
            id="select_subgroup" checked="checked" />
 <label for="select_subgroup" style="float:none">تحديد</label>
 <select name="subgroup" id="subgroup_select">
 <option value="">(لا شيء)</option>
 [% FOREACH group IN groups_with_subgroups %]
 [% IF (group.selected) %]
 [% FOREACH subgroup IN group.subgroups %]
 [% IF (subgroup.selected) %]
 <option value="[% subgroup.id | html %]" selected="selected">
 [% ELSE %]
 <option value="[% subgroup.id | html %]">
 [% END %]
 [% subgroup.name | html %]
 </option>
 [% END %]
 [% END %]
 [% END %]
 </select>
 <input type="radio" name="select_or_create_subgroup"
            id="create_subgroup" />
 <label for="create_subgroup" style="float:none">أو قم بإنشاء</label>
 <input id="subgroup_input" name="subgroup" placeholder="رمز" title="رمز المجموعة الفرعية" type="text" />
 <input id="subgroupdesc_input" name="subgroupdesc" placeholder="الاسم" title="اسم المجموعة الفرعية" type="text" />
 </li>
[% END %]

[% BLOCK insert_runtime_parameter %]
 <div class="btn-group"  style="margin-left:30px;">
 <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
 إدخال معامل وقت التشغيل <span class="caret"></span>
 </button>
 <ul class="dropdown-menu">
 <li><a href="#" class="insertParam" id="insertAuthVal">قيم الاستناد</a></li>
 <li><a href="#" class="insertParam" id="insertFramework">إطار بيبلوغرافي</a></li>
 <li><a href="#" class="insertParam" id="insertCnSource">مصادر التصنيف</a></li>
 <li><a href="#" class="insertParam" id="insertDate">التاريخ</a></li>
 <li><a href="#" class="insertParam" id="insertItemtypes">أنواع المادة</a></li>
 <li><a href="#" class="insertParam" id="insertBranches">المكتبات</a></li>
 <li><a href="#" class="insertParam" id="insertList">القائمة</a></li>
 <li><a href="#" class="insertParam" id="insertCategorycode">فئات المستفيد</a></li>
 <li><a href="#" class="insertParam" id="insertCashregister">سجلات نقدية</a></li>
 <li><a href="#" class="insertParam" id="insertDebittypes">أنواع حساب المدين</a></li>
 <li><a href="#" class="insertParam" id="insertCredittypes">أنواع حساب الدائن</a></li>
 <li><a href="#" class="insertParam" id="insertText">حقل النص</a></li>
 </ul>
 </div>
[% END %]
